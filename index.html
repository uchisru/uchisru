<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>учись.ру | Панель администратора</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-blue: #4cc9f0;
      --primary-purple: #9d4edd;
      --primary-pink: #f72585;
      --danger-red: #ff4d6d;
      --success-green: #4cc9a0;
      --warning-orange: #ff9e00;
      --glass-dark: rgba(30, 30, 46, 0.8);
      --glass-light: rgba(40, 40, 60, 0.6);
      --text-light: #cdd6f7;
      --text-dark: #1e1e2e;
      --bg-primary: #0f0f1a;
      --bg-secondary: #1a1a2e;
      --bg-card: #2d2d42;
      --accent-gradient: linear-gradient(135deg, #4cc9f0, #9d4edd, #f72585);
      --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.3);
      --shadow-hard: 0 20px 60px rgba(0, 0, 0, 0.5);
      --border-radius: 20px;
      --border-radius-sm: 12px;
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a14 0%, #1a1a2e 100%);
      color: var(--text-light);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* Главная страница */
    .login-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, #0a0a14 0%, #1a1a2e 100%);
    }

    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      width: 100px;
      height: 100px;
      background: var(--accent-gradient);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      color: var(--bg-primary);
      font-size: 2.5rem;
      box-shadow: var(--shadow-hard);
    }

    h1 {
      font-size: 3rem;
      font-weight: 800;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 10px;
    }

    .subtitle {
      color: var(--text-light);
      font-size: 1.1rem;
      max-width: 500px;
      opacity: 0.8;
    }

    /* Карточки выбора роли */
    .role-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      max-width: 1000px;
      width: 100%;
      margin-top: 30px;
    }

    .role-card {
      background: var(--glass-dark);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 40px 30px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition-smooth);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .role-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(1);
    }

    .role-card.disabled::after {
      content: '⛔ ВЫКЛЮЧЕНО';
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--danger-red);
      color: var(--text-light);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .role-card:hover:not(.disabled) {
      transform: translateY(-10px);
      box-shadow: var(--shadow-hard);
      border-color: rgba(76, 201, 240, 0.3);
    }

    .role-icon {
      font-size: 3rem;
      margin-bottom: 20px;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Форма входа */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .login-modal.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .login-form {
      background: var(--glass-dark);
      backdrop-filter: blur(30px);
      border-radius: var(--border-radius);
      padding: 40px;
      width: 90%;
      max-width: 400px;
      box-shadow: var(--shadow-hard);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateY(20px);
      animation: slideUp 0.3s ease forwards;
    }

    @keyframes slideUp {
      to { transform: translateY(0); }
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition-smooth);
    }

    .close-btn:hover {
      color: var(--danger-red);
      transform: rotate(90deg);
    }

    /* Панель админа */
    .admin-dashboard {
      display: none;
      min-height: 100vh;
      background: var(--bg-primary);
    }

    .admin-dashboard.active {
      display: block;
    }

    .admin-header {
      background: linear-gradient(135deg, #1a1a2e, #0f0f1a);
      color: var(--text-light);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .admin-nav {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding: 5px;
    }

    .admin-nav button {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: var(--transition-smooth);
      font-weight: 500;
      white-space: nowrap;
    }

    .admin-nav button:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      border-color: var(--primary-blue);
    }

    .admin-nav button.active {
      background: var(--accent-gradient);
      border: none;
    }

    .admin-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    /* Панели админа */
    .admin-panel {
      background: var(--glass-dark);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .admin-panel h2 {
      margin-bottom: 25px;
      color: var(--text-light);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Сетки */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: var(--border-radius-sm);
      padding: 25px;
      box-shadow: var(--shadow-soft);
      border-left: 5px solid var(--primary-blue);
      transition: var(--transition-smooth);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hard);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 10px 0;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Кнопки */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-smooth);
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: var(--text-light);
    }

    .btn-success {
      background: var(--success-green);
      color: var(--text-light);
    }

    .btn-danger {
      background: var(--danger-red);
      color: var(--text-light);
    }

    .btn-warning {
      background: var(--warning-orange);
      color: var(--text-light);
    }

    .btn-secondary {
      background: rgba(76, 201, 240, 0.1);
      color: var(--primary-blue);
      border: 1px solid rgba(76, 201, 240, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* Переключатели */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
      cursor: pointer;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #555;
      transition: .4s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: var(--text-light);
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--success-green);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }

    /* Таблицы */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: var(--bg-card);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
    }

    .data-table th,
    .data-table td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .data-table th {
      background: rgba(76, 201, 240, 0.1);
      font-weight: 600;
      color: var(--primary-blue);
    }

    .data-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Карточки функций */
    .function-card {
      background: var(--bg-card);
      border-radius: var(--border-radius-sm);
      padding: 25px;
      box-shadow: var(--shadow-soft);
      transition: var(--transition-smooth);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
    }

    .function-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hard);
      border-color: var(--primary-blue);
    }

    .function-card i {
      font-size: 2rem;
      margin-bottom: 15px;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Уведомления */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-card);
      padding: 15px 25px;
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-hard);
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      border-left: 5px solid var(--success-green);
      color: var(--text-light);
    }

    .notification.error {
      border-left-color: var(--danger-red);
    }

    .notification.warning {
      border-left-color: var(--warning-orange);
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Состояние сайта */
    .site-status {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .status-online {
      background: rgba(76, 201, 160, 0.1);
      color: var(--success-green);
      border: 1px solid rgba(76, 201, 160, 0.3);
    }

    .status-offline {
      background: rgba(255, 77, 109, 0.1);
      color: var(--danger-red);
      border: 1px solid rgba(255, 77, 109, 0.3);
    }

    /* Модальные окна */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 40px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-hard);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
    }

    /* Логи действий */
    .log-entry {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-time {
      color: var(--text-light);
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .log-action {
      font-weight: 600;
      margin-left: 10px;
    }

    /* Прогресс бар */
    .progress-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent-gradient);
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    /* Инпуты и селекты */
    input, select, textarea {
      background: var(--bg-card);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      padding: 10px;
      border-radius: 8px;
      transition: var(--transition-smooth);
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.2);
    }

    /* Поле поиска */
    .search-box {
      position: relative;
      flex: 1;
    }

    .search-box input {
      width: 100%;
      padding-left: 40px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
      opacity: 0.5;
    }

    /* Аккордеон для настроек */
    .accordion {
      background: var(--bg-card);
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      margin-bottom: 15px;
    }

    .accordion-header {
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition-smooth);
    }

    .accordion-header:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .accordion-content {
      padding: 0 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .accordion.active .accordion-content {
      padding: 20px;
      max-height: 1000px;
    }

    /* Адаптивность */
    @media (max-width: 1200px) {
      .admin-nav {
        gap: 10px;
      }
      .admin-nav button {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
    }

    @media (max-width: 768px) {
      .role-cards {
        grid-template-columns: 1fr;
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .admin-nav {
        flex-wrap: wrap;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .admin-header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }
      
      .admin-nav {
        width: 100%;
        justify-content: center;
      }
    }

    /* Анимации */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Загрузка */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--primary-blue);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Тэги */
    .tag {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin: 2px;
    }

    .tag-primary {
      background: rgba(76, 201, 240, 0.1);
      color: var(--primary-blue);
      border: 1px solid rgba(76, 201, 240, 0.3);
    }

    .tag-success {
      background: rgba(76, 201, 160, 0.1);
      color: var(--success-green);
      border: 1px solid rgba(76, 201, 160, 0.3);
    }

    .tag-warning {
      background: rgba(255, 158, 0, 0.1);
      color: var(--warning-orange);
      border: 1px solid rgba(255, 158, 0, 0.3);
    }

    .tag-danger {
      background: rgba(255, 77, 109, 0.1);
      color: var(--danger-red);
      border: 1px solid rgba(255, 77, 109, 0.3);
    }

    /* Загрузка файлов */
    .file-upload-area {
      border: 2px dashed rgba(76, 201, 240, 0.3);
      border-radius: var(--border-radius-sm);
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
      transition: var(--transition-smooth);
    }

    .file-upload-area:hover {
      border-color: var(--primary-blue);
      background: rgba(76, 201, 240, 0.05);
    }

    .file-upload-area i {
      font-size: 3rem;
      color: var(--primary-blue);
      margin-bottom: 15px;
    }

    /* Скрытые элементы */
    .admin-tab {
      display: none;
    }
    
    .admin-tab.active {
      display: block;
    }

    /* Панель загрузки */
    .upload-progress {
      margin: 20px 0;
      display: none;
    }

    .upload-progress.active {
      display: block;
    }

    /* Выделенные файлы */
    .file-item.selected {
      border-color: var(--primary-blue);
      background: rgba(76, 201, 240, 0.1);
    }

    /* Восстановление пароля */
    .password-reset-form {
      display: none;
    }

    .password-reset-form.active {
      display: block;
    }

    /* Тестовый редактор */
    .test-editor {
      background: var(--bg-card);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .test-editor.active {
      display: block;
    }

    /* Контент редактор */
    .content-editor {
      background: var(--bg-card);
      border-radius: var(--border-radius-sm);
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .content-editor.active {
      display: block;
    }

    /* Ассистент Рекс */
    .rex-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      border: none;
      box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      z-index: 9999;
      transition: all 0.3s ease;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .rex-button:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 35px rgba(255, 107, 157, 0.6);
    }

    .rex-button:active {
      transform: scale(0.95);
    }

    .rex-chat {
      position: fixed;
      bottom: 120px;
      right: 30px;
      width: 400px;
      height: 600px;
      background: var(--bg-card);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      display: none;
      flex-direction: column;
      z-index: 9998;
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: scaleIn 0.3s ease;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .rex-chat.active {
      display: flex;
    }

    .rex-header {
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      padding: 20px;
      border-radius: 20px 20px 0 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
    }

    .rex-header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .rex-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .rex-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .rex-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .rex-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .rex-message {
      display: flex;
      gap: 10px;
      animation: slideInUp 0.3s ease;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .rex-message.user {
      flex-direction: row-reverse;
    }

    .rex-message-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .rex-message.rex .rex-message-avatar {
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      color: white;
    }

    .rex-message.user .rex-message-avatar {
      background: var(--primary-blue);
      color: white;
    }

    .rex-message-content {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 16px;
      border-radius: 15px;
      max-width: 70%;
      color: var(--text-light);
      line-height: 1.5;
    }

    .rex-message.user .rex-message-content {
      background: var(--primary-blue);
      color: white;
    }

    .rex-input-area {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 10px;
    }

    .rex-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--text-light);
      padding: 12px 16px;
      border-radius: 25px;
      outline: none;
      transition: all 0.3s;
    }

    .rex-input:focus {
      border-color: #ff6b9d;
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.2);
    }

    .rex-send {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b9d, #c44569);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .rex-send:hover {
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
    }

    .rex-send:active {
      transform: scale(0.95);
    }

    .rex-typing {
      display: flex;
      gap: 5px;
      padding: 10px;
    }

    .rex-typing span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ff6b9d;
      animation: typing 1.4s infinite;
    }

    .rex-typing span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .rex-typing span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-10px);
      }
    }

    @media (max-width: 768px) {
      .rex-button {
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        font-size: 1.8rem;
      }

      .rex-chat {
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }

      .rex-header {
        border-radius: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Главная страница -->
  <div id="loginPage" class="login-page">
    <div class="login-header">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
      </div>
      <h1>учись.ру</h1>
      <p class="subtitle">Образовательная платформа с полным контролем администратора</p>
      <div class="site-status status-online" id="globalStatus">
        <i class="fas fa-circle"></i>
        Сайт работает
      </div>
    </div>

    <div class="role-cards">
      <div class="role-card" id="teacherCard" onclick="openLogin('teacher')">
        <div class="role-icon">
          <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <h3>Учитель</h3>
        <p>Создание заданий, проверка работ, аналитика</p>
        <div class="role-status"></div>
      </div>

      <div class="role-card" id="studentCard" onclick="openLogin('student')">
        <div class="role-icon">
          <i class="fas fa-user-graduate"></i>
        </div>
        <h3>Ученик</h3>
        <p>Выполнение заданий, отслеживание прогресса</p>
        <div class="role-status"></div>
      </div>

      <div class="role-card" onclick="openLogin('admin')">
        <div class="role-icon">
          <i class="fas fa-crown"></i>
        </div>
        <h3>Администратор</h3>
        <p>Полный контроль системы</p>
        <div class="site-status status-online" style="margin-top: 15px;">
          <i class="fas fa-shield-alt"></i>
          Доступ открыт
        </div>
      </div>
    </div>

    <div style="margin-top: 40px; text-align: center; color: var(--text-light); opacity: 0.7;">
      <p><i class="fas fa-lock"></i> Все данные защищены и шифруются</p>
    </div>
  </div>

  <!-- Форма входа -->
  <div id="loginModal" class="login-modal">
    <div class="login-form">
      <button class="close-btn" onclick="closeLogin()">
        <i class="fas fa-times"></i>
      </button>
      <h2 id="modalTitle" style="margin-bottom: 30px;">Вход в систему</h2>
      
      <div id="loginForm">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Логин</label>
          <input type="text" id="loginInput" style="width: 100%;" 
                 placeholder="Введите логин">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Пароль</label>
          <input type="password" id="passwordInput" style="width: 100%;" 
                 placeholder="Введите пароль">
        </div>
        
        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <input type="checkbox" id="rememberMe">
          <label for="rememberMe" style="cursor: pointer;">Запомнить меня</label>
        </div>
        
        <button class="btn btn-primary" onclick="performLogin()" style="width: 100%;">
          <i class="fas fa-sign-in-alt"></i>
          Войти
        </button>

        <div style="margin-top: 20px; text-align: center;">
          <a href="#" onclick="showPasswordReset()" style="color: var(--primary-blue); text-decoration: none;">
            <i class="fas fa-key"></i> Забыли пароль?
          </a>
        </div>
      </div>

      <!-- Форма восстановления пароля -->
      <div id="passwordResetForm" class="password-reset-form">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email</label>
          <input type="email" id="resetEmail" style="width: 100%;" 
                 placeholder="Введите email для восстановления">
        </div>
        
        <button class="btn btn-primary" onclick="resetPassword()" style="width: 100%; margin-bottom: 10px;">
          <i class="fas fa-paper-plane"></i>
          Отправить ссылку для восстановления
        </button>
        
        <div style="text-align: center;">
          <a href="#" onclick="showLoginForm()" style="color: var(--primary-blue); text-decoration: none;">
            <i class="fas fa-arrow-left"></i> Вернуться ко входу
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Дашборд администратора -->
  <div id="adminDashboard" class="admin-dashboard">
    <!-- Шапка админа -->
    <div class="admin-header">
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="width: 40px; height: 40px; background: var(--accent-gradient); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-light);">
          <i class="fas fa-crown"></i>
        </div>
        <div>
          <div style="font-weight: 700;">Администратор системы</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Полный контроль платформы</div>
        </div>
      </div>
      
      <div class="admin-nav">
        <button onclick="switchAdminTab('dashboard')" class="active"><i class="fas fa-tachometer-alt"></i> Дашборд</button>
        <button onclick="switchAdminTab('users')"><i class="fas fa-users"></i> Пользователи</button>
        <button onclick="switchAdminTab('files')"><i class="fas fa-folder"></i> Файлы</button>
        <button onclick="switchAdminTab('content')"><i class="fas fa-book"></i> Контент</button>
        <button onclick="switchAdminTab('analytics')"><i class="fas fa-chart-bar"></i> Аналитика</button>
        <button onclick="switchAdminTab('settings')"><i class="fas fa-cogs"></i> Настройки</button>
        <button onclick="switchAdminTab('logs')"><i class="fas fa-history"></i> Логи</button>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="openAdminChat()">
          <i class="fas fa-comments"></i> Чат
        </button>
        <button class="btn btn-danger" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Выйти
        </button>
      </div>
    </div>

    <!-- Контент админ панели -->
    <div class="admin-container">
      <!-- Дашборд -->
      <div id="adminDashboardTab" class="admin-tab active">
        <div class="admin-panel">
          <h2><i class="fas fa-tachometer-alt"></i> Панель управления системой</h2>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div style="color: var(--text-light); font-size: 0.9rem; opacity: 0.8;">Всего пользователей</div>
              <div class="stat-value" id="totalUsers">0</div>
              <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <span>Учителей: <strong id="teacherCount">0</strong></span>
                <span>Учеников: <strong id="studentCount">0</strong></span>
              </div>
            </div>
            
            <div class="stat-card">
              <div style="color: var(--text-light); font-size: 0.9rem; opacity: 0.8;">Активность за 24ч</div>
              <div class="stat-value" id="dailyActivity">0</div>
              <div class="progress-bar">
                <div class="progress-fill" id="activityProgress" style="width: 0%"></div>
              </div>
            </div>
            
            <div class="stat-card">
              <div style="color: var(--text-light); font-size: 0.9rem; opacity: 0.8;">Статус системы</div>
              <div class="stat-value" id="systemStatus">100%</div>
              <div id="statusIndicator" class="site-status status-online" style="margin-top: 10px;">
                <i class="fas fa-circle"></i>
                Все системы работают
              </div>
            </div>

            <div class="stat-card">
              <div style="color: var(--text-light); font-size: 0.9rem; opacity: 0.8;">Файлы</div>
              <div class="stat-value" id="totalFiles">6</div>
              <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <span>Материалы: <strong id="materialsCount">4</strong></span>
                <span>Папки: <strong id="foldersCount">2</strong></span>
              </div>
            </div>
          </div>

          <!-- Быстрые действия -->
          <h3 style="margin: 30px 0 20px;"><i class="fas fa-bolt"></i> Быстрые действия</h3>
          <div class="grid">
            <div class="function-card" onclick="showCreateCardModal()" style="background: linear-gradient(135deg, rgba(76, 201, 240, 0.1), rgba(157, 78, 221, 0.1)); border: 2px solid var(--primary-blue);">
              <i class="fas fa-plus-circle" style="color: var(--primary-blue);"></i>
              <h4 style="color: var(--primary-blue);">Создать карточку</h4>
              <p>Создать новую карточку с заданием для учеников</p>
              <button class="btn btn-primary" style="margin-top: 15px;">
                <i class="fas fa-plus"></i> Создать
              </button>
            </div>
            
            <div class="function-card" onclick="toggleAccess('teachers')">
              <i class="fas fa-chalkboard-teacher"></i>
              <h4>Учителя</h4>
              <p>Включить/выключить доступ для учителей</p>
              <label class="toggle-switch" style="margin-top: 15px;">
                <input type="checkbox" id="toggleTeachers" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="function-card" onclick="toggleAccess('students')">
              <i class="fas fa-user-graduate"></i>
              <h4>Ученики</h4>
              <p>Включить/выключить доступ для учеников</p>
              <label class="toggle-switch" style="margin-top: 15px;">
                <input type="checkbox" id="toggleStudents" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div class="function-card" onclick="openModal('managePointsModal')">
              <i class="fas fa-coins"></i>
              <h4>Управление баллами</h4>
              <p>Добавить или снять баллы ученикам</p>
              <button class="btn btn-primary" style="margin-top: 15px;">
                <i class="fas fa-edit"></i> Управлять
              </button>
            </div>
            
            <div class="function-card" onclick="openModal('massNotificationModal')">
              <i class="fas fa-bullhorn"></i>
              <h4>Массовая рассылка</h4>
              <p>Отправить сообщение всем пользователям</p>
              <button class="btn btn-primary" style="margin-top: 15px;">
                <i class="fas fa-paper-plane"></i> Отправить
              </button>
            </div>
            
            <div class="function-card" onclick="openModal('resetProgressModal')">
              <i class="fas fa-redo"></i>
              <h4>Сброс прогресса</h4>
              <p>Сбросить прогресс учеников</p>
              <button class="btn btn-warning" style="margin-top: 15px;">
                <i class="fas fa-trash"></i> Сбросить
              </button>
            </div>
            
            <div class="function-card" onclick="openModal('blockUserModal')">
              <i class="fas fa-ban"></i>
              <h4>Блокировка</h4>
              <p>Заблокировать пользователя</p>
              <button class="btn btn-danger" style="margin-top: 15px;">
                <i class="fas fa-ban"></i> Заблокировать
              </button>
            </div>
            
            <div class="function-card" onclick="openModal('studentStatsModal')">
              <i class="fas fa-chart-line"></i>
              <h4>Статистика ученика</h4>
              <p>Детальная статистика по ученику</p>
              <button class="btn btn-success" style="margin-top: 15px;">
                <i class="fas fa-eye"></i> Просмотр
              </button>
            </div>
            
            <div class="function-card" onclick="exportAllData()">
              <i class="fas fa-file-export"></i>
              <h4>Экспорт данных</h4>
              <p>Выгрузить все данные в JSON</p>
              <button class="btn btn-secondary" style="margin-top: 15px;">
                <i class="fas fa-download"></i> Экспорт
              </button>
            </div>
            
            <div class="function-card" onclick="clearSystemCache()">
              <i class="fas fa-broom"></i>
              <h4>Очистка кэша</h4>
              <p>Очистить системный кэш и временные файлы</p>
              <button class="btn btn-warning" style="margin-top: 15px;">
                <i class="fas fa-trash"></i> Очистить
              </button>
            </div>
            
            <div class="function-card" onclick="showEmergencyPanel()">
              <i class="fas fa-exclamation-triangle"></i>
              <h4>Аварийный режим</h4>
              <p>Экстренное выключение системы</p>
              <button class="btn btn-danger" style="margin-top: 15px;">
                <i class="fas fa-power-off"></i> Аварийное отключение
              </button>
            </div>
            
            <div class="function-card" onclick="viewAllStudentsProgress()">
              <i class="fas fa-tasks"></i>
              <h4>Прогресс всех учеников</h4>
              <p>Просмотр прогресса всех учеников</p>
              <button class="btn btn-success" style="margin-top: 15px;">
                <i class="fas fa-list"></i> Просмотр
              </button>
            </div>
          </div>

          <!-- Последняя активность -->
          <h3 style="margin: 40px 0 20px;"><i class="fas fa-history"></i> Последняя активность</h3>
          <div id="recentActivity" style="background: var(--bg-card); border-radius: var(--border-radius-sm); padding: 20px;">
            <!-- Заполнится динамически -->
          </div>
        </div>
      </div>

      <!-- Управление пользователями -->
      <div id="adminUsersTab" class="admin-tab">
        <div class="admin-panel">
          <h2><i class="fas fa-users"></i> Управление пользователями</h2>
          
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="showAddUserModal()">
              <i class="fas fa-user-plus"></i> Добавить пользователя
            </button>
            <button class="btn btn-secondary" onclick="showImportUsersModal()">
              <i class="fas fa-file-import"></i> Импорт пользователей
            </button>
            <button class="btn btn-warning" onclick="exportUsersData()">
              <i class="fas fa-file-export"></i> Экспорт данных
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedUsers()">
              <i class="fas fa-trash"></i> Удалить выбранных
            </button>
            <button class="btn btn-success" onclick="generateUserReport()">
              <i class="fas fa-chart-pie"></i> Отчёт по пользователям
            </button>
          </div>

          <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="searchUsersInput" placeholder="Поиск пользователей..." onkeyup="searchUsers()">
            </div>
            <select id="filterRole" onchange="filterUsers()" style="min-width: 150px;">
              <option value="">Все роли</option>
              <option value="teacher">Учителя</option>
              <option value="student">Ученики</option>
              <option value="admin">Администраторы</option>
            </select>
            <select id="filterStatus" onchange="filterUsers()" style="min-width: 150px;">
              <option value="">Все статусы</option>
              <option value="active">Активные</option>
              <option value="inactive">Неактивные</option>
              <option value="blocked">Заблокированные</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshUsers()">
              <i class="fas fa-redo"></i> Обновить
            </button>
          </div>

          <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong id="usersCount">0</strong> пользователей найдено
            </div>
            <div>
              <label>
                <input type="checkbox" id="selectAllUsers" onchange="selectAllUsers()">
                Выбрать всех
              </label>
            </div>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th style="width: 50px;">Выбор</th>
                <th>ID</th>
                <th>Логин</th>
                <th>Имя</th>
                <th>Роль</th>
                <th>Email</th>
                <th>Статус</th>
                <th>Последний вход</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="usersTable">
              <!-- Заполнится динамически -->
            </tbody>
          </table>

          <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <div id="paginationInfo">Страница 1 из 1</div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-secondary" onclick="prevPage()">
                <i class="fas fa-chevron-left"></i> Назад
              </button>
              <button class="btn btn-secondary" onclick="nextPage()">
                Вперед <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Управление файлами -->
      <div id="adminFilesTab" class="admin-tab">
        <div class="admin-panel">
          <h2><i class="fas fa-folder"></i> Управление файлами</h2>
          
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="showUploadModal()">
              <i class="fas fa-upload"></i> Загрузить файлы
            </button>
            <button class="btn btn-secondary" onclick="createNewFolder()">
              <i class="fas fa-folder-plus"></i> Создать папку
            </button>
            <button class="btn btn-warning" onclick="organizeFiles()">
              <i class="fas fa-folder-tree"></i> Организовать
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedFiles()">
              <i class="fas fa-trash"></i> Удалить выбранные
            </button>
            <button class="btn btn-success" onclick="downloadSelectedFiles()">
              <i class="fas fa-download"></i> Скачать выбранные
            </button>
          </div>

          <!-- Область загрузки -->
          <div class="file-upload-area" onclick="triggerFileUpload()" id="uploadArea">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3>Перетащите файлы сюда или кликните для загрузки</h3>
            <p style="opacity: 0.7; margin-top: 10px;">Поддерживаются файлы до 100MB</p>
            <input type="file" id="fileUploadInput" multiple style="display: none;" onchange="handleFileUpload(this.files)">
          </div>

          <!-- Прогресс загрузки -->
          <div id="uploadProgress" class="upload-progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Загрузка файлов...</span>
              <span id="uploadPercentage">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="uploadProgressBar" style="width: 0%"></div>
            </div>
            <div id="uploadStatus" style="font-size: 0.9rem; margin-top: 5px;"></div>
          </div>

          <div style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;"><i class="fas fa-files"></i> Файлы и папки</h3>
            <div style="display: flex; gap: 10px;">
              <select id="fileSort" onchange="sortFiles()">
                <option value="name">По имени</option>
                <option value="date">По дате</option>
                <option value="size">По размеру</option>
                <option value="type">По типу</option>
              </select>
              <select id="fileFilter" onchange="filterFiles()">
                <option value="all">Все файлы</option>
                <option value="images">Изображения</option>
                <option value="documents">Документы</option>
                <option value="videos">Видео</option>
                <option value="audio">Аудио</option>
                <option value="folders">Папки</option>
              </select>
            </div>
          </div>

          <!-- Путь -->
          <div style="margin-bottom: 15px; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
            <i class="fas fa-folder" style="color: var(--primary-blue); margin-right: 10px;"></i>
            <span id="currentPath">/ Файлы</span>
            <button class="btn btn-secondary" onclick="goToParentFolder()" style="float: right; padding: 5px 10px;">
              <i class="fas fa-level-up-alt"></i> Наверх
            </button>
          </div>

          <!-- Сетка файлов -->
          <div class="grid" id="filesGrid">
            <!-- Файлы будут добавлены динамически -->
          </div>

          <!-- Статистика -->
          <div style="margin-top: 30px; padding: 20px; background: var(--bg-card); border-radius: var(--border-radius-sm);">
            <h3><i class="fas fa-chart-pie"></i> Статистика файлов</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
              <div>
                <div style="font-size: 0.9rem; opacity: 0.8;">Всего файлов</div>
                <div class="stat-value" style="font-size: 2rem;" id="totalFilesCount">0</div>
              </div>
              <div>
                <div style="font-size: 0.9rem; opacity: 0.8;">Использовано места</div>
                <div class="stat-value" style="font-size: 2rem;" id="totalSize">0 MB</div>
                <div class="progress-bar" style="width: 100%; margin-top: 5px;">
                  <div class="progress-fill" id="storageProgress" style="width: 0%"></div>
                </div>
              </div>
              <div>
                <div style="font-size: 0.9rem; opacity: 0.8;">Папки / Файлы</div>
                <div class="stat-value" style="font-size: 2rem;" id="foldersFilesCount">0 / 0</div>
              </div>
              <div>
                <div style="font-size: 0.9rem; opacity: 0.8;">Последняя загрузка</div>
                <div class="stat-value" style="font-size: 2rem;" id="lastUpload">Сегодня</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Управление контентом -->
      <div id="adminContentTab" class="admin-tab">
        <div class="admin-panel">
          <h2><i class="fas fa-book"></i> Управление контентом</h2>
          
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="showCreateCardModal()">
              <i class="fas fa-plus"></i> Создать карточку
            </button>
            <button class="btn btn-secondary" onclick="createNewContent()">
              <i class="fas fa-file"></i> Создать контент
            </button>
            <button class="btn btn-secondary" onclick="importContent()">
              <i class="fas fa-upload"></i> Импорт контента
            </button>
            <button class="btn btn-warning" onclick="organizeContent()">
              <i class="fas fa-folder"></i> Организовать
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedContent()">
              <i class="fas fa-trash"></i> Удалить выбранное
            </button>
          </div>

          <!-- Редактор контента -->
          <div id="contentEditor" class="content-editor">
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px;">Название контента</label>
              <input type="text" id="contentTitle" style="width: 100%;" placeholder="Введите название">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px;">Тип контента</label>
              <select id="contentType" style="width: 100%;">
                <option value="card">Карточка обучения</option>
                <option value="assignment">Задание</option>
                <option value="test">Тест</option>
                <option value="material">Учебный материал</option>
              </select>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px;">Содержание</label>
              <textarea id="contentBody" style="width: 100%; height: 200px;" placeholder="Введите содержание..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-success" onclick="saveContent()">
                <i class="fas fa-save"></i> Сохранить
              </button>
              <button class="btn btn-secondary" onclick="hideContentEditor()">
                <i class="fas fa-times"></i> Отмена
              </button>
            </div>
          </div>

          <div class="grid">
            <div class="function-card" onclick="manageCards()">
              <i class="fas fa-layer-group"></i>
              <h4>Карточки обучения</h4>
              <p>Создание и редактирование учебных карточек</p>
              <div class="stat-value" style="font-size: 1.5rem; margin-top: 10px;" id="cardsCount">12</div>
            </div>
            
            <div class="function-card" onclick="manageAssignments()">
              <i class="fas fa-tasks"></i>
              <h4>Задания</h4>
              <p>Управление домашними заданиями</p>
              <div class="stat-value" style="font-size: 1.5rem; margin-top: 10px;" id="assignmentsCount">24</div>
            </div>
            
            <div class="function-card" onclick="showTestEditor()">
              <i class="fas fa-file-alt"></i>
              <h4>Тесты</h4>
              <p>Создание и настройка тестов</p>
              <button class="btn btn-primary" style="margin-top: 15px;">
                <i class="fas fa-plus"></i> Новый тест
              </button>
            </div>
            
            <div class="function-card" onclick="manageCategories()">
              <i class="fas fa-tags"></i>
              <h4>Категории</h4>
              <p>Управление категориями и тегами</p>
              <button class="btn btn-secondary" style="margin-top: 15px;">
                <i class="fas fa-edit"></i> Редактировать
              </button>
            </div>
            
            <div class="function-card" onclick="publishContent()">
              <i class="fas fa-paper-plane"></i>
              <h4>Публикация</h4>
              <p>Публикация и распространение контента</p>
              <button class="btn btn-success" style="margin-top: 15px;">
                <i class="fas fa-share"></i> Опубликовать
              </button>
            </div>
            
            <div class="function-card" onclick="contentAnalytics()">
              <i class="fas fa-chart-pie"></i>
              <h4>Аналитика контента</h4>
              <p>Статистика использования материалов</p>
              <div class="progress-bar" style="margin-top: 15px;">
                <div class="progress-fill" style="width: 78%"></div>
              </div>
            </div>
          </div>

          <!-- Редактор тестов -->
          <div id="testEditor" class="test-editor">
            <h3><i class="fas fa-file-alt"></i> Создание нового теста</h3>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px;">Название теста</label>
              <input type="text" id="testTitle" style="width: 100%;" placeholder="Введите название теста">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 8px;">Описание</label>
              <textarea id="testDescription" style="width: 100%; height: 100px;" placeholder="Опишите тест..."></textarea>
            </div>
            
            <div id="testQuestions">
              <h4>Вопросы теста</h4>
              <div class="question-item" style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <input type="text" placeholder="Вопрос" style="width: 100%; margin-bottom: 10px;">
                <input type="text" placeholder="Вариант ответа 1" style="width: 100%; margin-bottom: 5px;">
                <input type="text" placeholder="Вариант ответа 2" style="width: 100%; margin-bottom: 5px;">
                <input type="text" placeholder="Вариант ответа 3" style="width: 100%; margin-bottom: 10px;">
                <select style="width: 100%;">
                  <option value="">Выберите правильный ответ</option>
                  <option value="1">Вариант 1</option>
                  <option value="2">Вариант 2</option>
                  <option value="3">Вариант 3</option>
                </select>
              </div>
            </div>
            
            <button class="btn btn-secondary" onclick="addTestQuestion()" style="margin-bottom: 20px;">
              <i class="fas fa-plus"></i> Добавить вопрос
            </button>
            
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-success" onclick="saveTest()">
                <i class="fas fa-save"></i> Сохранить тест
              </button>
              <button class="btn btn-secondary" onclick="hideTestEditor()">
                <i class="fas fa-times"></i> Отмена
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Аналитика -->
      <div id="adminAnalyticsTab" class="admin-tab">
        <div class="admin-panel">
          <h2><i class="fas fa-chart-bar"></i> Аналитика системы</h2>
          
          <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="generateReport()">
              <i class="fas fa-file-pdf"></i> Создать отчёт
            </button>
            <button class="btn btn-secondary" onclick="exportAnalytics()">
              <i class="fas fa-download"></i> Экспорт данных
            </button>
            <button class="btn btn-warning" onclick="refreshAnalytics()">
              <i class="fas fa-redo"></i> Обновить
            </button>
          </div>

          <div class="grid">
            <div class="function-card">
              <i class="fas fa-chart-line"></i>
              <h4>Активность пользователей</h4>
              <p>График активности за 30 дней</p>
              <div style="margin-top: 15px; height: 150px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; display: flex; align-items: flex-end; padding: 10px;">
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="height: calc(100% * 0.85); width: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
                  <div style="margin-top: 5px; font-size: 0.8rem;">Пн</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="height: calc(100% * 0.92); width: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
                  <div style="margin-top: 5px; font-size: 0.8rem;">Вт</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="height: calc(100% * 0.78); width: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
                  <div style="margin-top: 5px; font-size: 0.8rem;">Ср</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="height: calc(100% * 0.95); width: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
                  <div style="margin-top: 5px; font-size: 0.8rem;">Чт</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="height: calc(100% * 0.88); width: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
                  <div style="margin-top: 5px; font-size: 0.8rem;">Пт</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="height: calc(100% * 0.65); width: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
                  <div style="margin-top: 5px; font-size: 0.8rem;">Сб</div>
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                  <div style="height: calc(100% * 0.45); width: 20px; background: var(--primary-blue); border-radius: 4px;"></div>
                  <div style="margin-top: 5px; font-size: 0.8rem;">Вс</div>
                </div>
              </div>
            </div>
            
            <div class="function-card">
              <i class="fas fa-graduation-cap"></i>
              <h4>Успеваемость</h4>
              <p>Средние оценки по группам</p>
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Группа 1</span>
                  <strong>4.5</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Группа 2</span>
                  <strong>4.2</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Группа 3</span>
                  <strong>4.0</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>Группа 4</span>
                  <strong>3.8</strong>
                </div>
              </div>
            </div>
            
            <div class="function-card">
              <i class="fas fa-tasks"></i>
              <h4>Выполнение заданий</h4>
              <p>Статистика выполнения заданий</p>
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Выполнено:</span>
                  <strong>85%</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>На проверке:</span>
                  <strong>10%</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>Просрочено:</span>
                  <strong>5%</strong>
                </div>
              </div>
            </div>
            
            <div class="function-card">
              <i class="fas fa-user-check"></i>
              <h4>Посещаемость</h4>
              <p>Статистика посещаемости</p>
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Сегодня:</span>
                  <strong>92%</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                  <span>Неделя:</span>
                  <strong>88%</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>Месяц:</span>
                  <strong>90%</strong>
                </div>
              </div>
            </div>
          </div>

          <h3 style="margin: 30px 0 20px;"><i class="fas fa-table"></i> Детальная статистика</h3>
          <table class="data-table">
            <thead>
              <tr>
                <th>Группа</th>
                <th>Учеников</th>
                <th>Средний балл</th>
                <th>Активность</th>
                <th>Посещаемость</th>
                <th>Рейтинг</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Группа 1</td>
                <td>25</td>
                <td>4.5</td>
                <td>95%</td>
                <td>92%</td>
                <td><span class="tag tag-success">Высокий</span></td>
              </tr>
              <tr>
                <td>Группа 2</td>
                <td>23</td>
                <td>4.2</td>
                <td>88%</td>
                <td>85%</td>
                <td><span class="tag tag-success">Высокий</span></td>
              </tr>
              <tr>
                <td>Группа 3</td>
                <td>27</td>
                <td>4.0</td>
                <td>82%</td>
                <td>80%</td>
                <td><span class="tag tag-warning">Средний</span></td>
              </tr>
              <tr>
                <td>Группа 4</td>
                <td>24</td>
                <td>3.8</td>
                <td>75%</td>
                <td>78%</td>
                <td><span class="tag tag-warning">Средний</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Настройки -->
      <div id="adminSettingsTab" class="admin-tab">
        <div class="admin-panel">
          <h2><i class="fas fa-cogs"></i> Настройки системы</h2>
          
          <div class="accordion" onclick="toggleAccordion(this)">
            <div class="accordion-header">
              <span><i class="fas fa-globe"></i> Основные настройки</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="accordion-content">
              <div style="margin-top: 15px;">
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px;">Название сайта</label>
                  <input type="text" id="siteName" value="учись.ру" style="width: 100%;">
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px;">Язык интерфейса</label>
                  <select id="siteLanguage" style="width: 100%;">
                    <option value="ru">Русский</option>
                    <option value="en">English</option>
                  </select>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px;">Время сессии (минут)</label>
                  <input type="number" id="sessionTimeout" value="60" style="width: 100%;">
                </div>
              </div>
            </div>
          </div>

          <div class="accordion" onclick="toggleAccordion(this)">
            <div class="accordion-header">
              <span><i class="fas fa-shield-alt"></i> Безопасность</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="accordion-content">
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <span>Требовать сложный пароль</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="requireStrongPassword" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <span>Блокировка после 5 неудачных попыток</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="blockAfterAttempts" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <span>Двухфакторная аутентификация</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="twoFactorAuth">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion" onclick="toggleAccordion(this)">
            <div class="accordion-header">
              <span><i class="fas fa-bell"></i> Уведомления</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="accordion-content">
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <span>Email уведомления</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="emailNotifications" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <span>Push-уведомления</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="pushNotifications">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                  <span>SMS уведомления</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="smsNotifications">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="accordion" onclick="toggleAccordion(this)">
            <div class="accordion-header">
              <span><i class="fas fa-database"></i> Хранение данных</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="accordion-content">
              <div style="margin-top: 15px;">
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px;">Автоматическое резервное копирование</label>
                  <select id="autoBackup" style="width: 100%;">
                    <option value="daily">Ежедневно</option>
                    <option value="weekly">Еженедельно</option>
                    <option value="monthly">Ежемесячно</option>
                    <option value="none">Отключено</option>
                  </select>
                </div>
                <div style="margin-bottom: 15px;">
                  <label style="display: block; margin-bottom: 5px;">Лимит хранения файлов (МБ)</label>
                  <input type="range" id="storageLimit" min="100" max="5000" value="1000" style="width: 100%;">
                  <div style="text-align: center; margin-top: 5px;" id="storageLimitValue">1000 MB</div>
                </div>
              </div>
            </div>
          </div>

          <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-primary" onclick="saveSettings()" style="padding: 15px 40px;">
              <i class="fas fa-save"></i> Сохранить настройки
            </button>
          </div>
        </div>
      </div>

      <!-- Логи -->
      <div id="adminLogsTab" class="admin-tab">
        <div class="admin-panel">
          <h2><i class="fas fa-history"></i> Логи системы</h2>
          
          <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-secondary" onclick="refreshLogs()">
              <i class="fas fa-redo"></i> Обновить
            </button>
            <button class="btn btn-danger" onclick="clearLogs()">
              <i class="fas fa-trash"></i> Очистить логи
            </button>
            <button class="btn btn-secondary" onclick="exportLogs()">
              <i class="fas fa-download"></i> Экспорт
            </button>
            <select id="logFilter" onchange="filterLogs()" style="min-width: 150px;">
              <option value="all">Все уровни</option>
              <option value="info">Информация</option>
              <option value="warning">Предупреждения</option>
              <option value="error">Ошибки</option>
              <option value="security">Безопасность</option>
            </select>
            <input type="date" id="logDate" onchange="filterLogsByDate()" style="min-width: 150px;">
          </div>

          <div style="background: var(--bg-card); border-radius: 10px; padding: 20px; max-height: 500px; overflow-y: auto;">
            <div id="systemLogs">
              <!-- Логи будут добавляться динамически -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно управления баллами ученика -->
  <div id="managePointsModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-coins"></i> Управление баллами</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Ученик</label>
        <select id="pointsStudentSelect" style="width: 100%;" onchange="loadStudentPoints()">
          <option value="">Выберите ученика</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px; padding: 15px; background: rgba(76, 201, 240, 0.1); border-radius: 10px;">
        <div style="font-size: 0.9rem; opacity: 0.8;">Текущие баллы</div>
        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-blue);" id="currentStudentPoints">0</div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Действие</label>
        <select id="pointsAction" style="width: 100%;">
          <option value="add">Добавить баллы</option>
          <option value="remove">Снять баллы</option>
          <option value="set">Установить баллы</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Количество баллов</label>
        <input type="number" id="pointsAmount" style="width: 100%;" placeholder="Введите количество" min="0">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Причина (необязательно)</label>
        <textarea id="pointsReason" style="width: 100%; min-height: 80px;" placeholder="Укажите причину изменения баллов"></textarea>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="applyPointsChange()" style="flex: 1;">
          <i class="fas fa-check"></i> Применить
        </button>
        <button class="btn btn-secondary" onclick="closeModal('managePointsModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <!-- Модальное окно массовой рассылки -->
  <div id="massNotificationModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-bullhorn"></i> Массовая рассылка</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Получатели</label>
        <select id="notificationRecipients" style="width: 100%;">
          <option value="all">Все пользователи</option>
          <option value="students">Все ученики</option>
          <option value="teachers">Все учителя</option>
          <option value="class">Определенная группа</option>
        </select>
      </div>
      
      <div id="classSelectDiv" style="margin-bottom: 20px; display: none;">
        <label style="display: block; margin-bottom: 8px;">Выберите группу</label>
        <select id="notificationClass" style="width: 100%;">
          <option value="5a">5А</option>
          <option value="5b">5Б</option>
          <option value="6a">6А</option>
          <option value="6b">6Б</option>
          <option value="7a">Группа 7</option>
          <option value="7b">Группа 8</option>
          <option value="8a">Группа 9</option>
          <option value="8b">Группа 10</option>
          <option value="9a">Группа 11</option>
          <option value="9b">Группа 12</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Тип уведомления</label>
        <select id="notificationType" style="width: 100%;">
          <option value="info">Информация</option>
          <option value="success">Успех</option>
          <option value="warning">Предупреждение</option>
          <option value="error">Важное</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Заголовок</label>
        <input type="text" id="notificationTitle" style="width: 100%;" placeholder="Введите заголовок">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Сообщение</label>
        <textarea id="notificationMessage" style="width: 100%; min-height: 120px;" placeholder="Введите текст сообщения"></textarea>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="sendMassNotification()" style="flex: 1;">
          <i class="fas fa-paper-plane"></i> Отправить
        </button>
        <button class="btn btn-secondary" onclick="closeModal('massNotificationModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <!-- Модальное окно сброса прогресса -->
  <div id="resetProgressModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-redo"></i> Сброс прогресса</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Ученик</label>
        <select id="resetStudentSelect" style="width: 100%;">
          <option value="">Выберите ученика</option>
          <option value="all">Все ученики</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Что сбросить?</label>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="resetCards" checked>
            <span>Пройденные карточки</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="resetPoints" checked>
            <span>Баллы</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="resetChat">
            <span>История чата</span>
          </label>
        </div>
      </div>
      
      <div style="padding: 15px; background: rgba(255, 77, 109, 0.1); border-radius: 10px; margin-bottom: 20px;">
        <i class="fas fa-exclamation-triangle" style="color: var(--danger-red);"></i>
        <strong style="color: var(--danger-red);">Внимание!</strong>
        <p style="margin-top: 10px; opacity: 0.9;">Это действие нельзя отменить. Все выбранные данные будут удалены безвозвратно.</p>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-danger" onclick="confirmResetProgress()" style="flex: 1;">
          <i class="fas fa-trash"></i> Сбросить
        </button>
        <button class="btn btn-secondary" onclick="closeModal('resetProgressModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <!-- Модальное окно блокировки пользователя -->
  <div id="blockUserModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-ban"></i> Блокировка пользователя</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Пользователь</label>
        <select id="blockUserSelect" style="width: 100%;">
          <option value="">Выберите пользователя</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Длительность блокировки</label>
        <select id="blockDuration" style="width: 100%;">
          <option value="1h">1 час</option>
          <option value="24h">24 часа</option>
          <option value="7d">7 дней</option>
          <option value="30d">30 дней</option>
          <option value="permanent">Навсегда</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Причина блокировки</label>
        <textarea id="blockReason" style="width: 100%; min-height: 100px;" placeholder="Укажите причину блокировки"></textarea>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-danger" onclick="blockUser()" style="flex: 1;">
          <i class="fas fa-ban"></i> Заблокировать
        </button>
        <button class="btn btn-secondary" onclick="closeModal('blockUserModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <!-- Модальное окно детальной статистики ученика -->
  <div id="studentStatsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-line"></i> Детальная статистика ученика</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Выберите ученика</label>
        <select id="statsStudentSelect" style="width: 100%;" onchange="loadStudentStats()">
          <option value="">Выберите ученика</option>
        </select>
      </div>
      
      <div id="studentStatsContent" style="display: none;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div style="padding: 15px; background: rgba(76, 201, 240, 0.1); border-radius: 10px;">
            <div style="font-size: 0.9rem; opacity: 0.8;">Всего баллов</div>
            <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary-blue);" id="statsTotalPoints">0</div>
          </div>
          <div style="padding: 15px; background: rgba(76, 201, 160, 0.1); border-radius: 10px;">
            <div style="font-size: 0.9rem; opacity: 0.8;">Пройдено карточек</div>
            <div style="font-size: 1.8rem; font-weight: 700; color: var(--success-green);" id="statsCompletedCards">0</div>
          </div>
          <div style="padding: 15px; background: rgba(157, 78, 221, 0.1); border-radius: 10px;">
            <div style="font-size: 0.9rem; opacity: 0.8;">Сообщений в чате</div>
            <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary-purple);" id="statsChatMessages">0</div>
          </div>
          <div style="padding: 15px; background: rgba(255, 158, 0, 0.1); border-radius: 10px;">
            <div style="font-size: 0.9rem; opacity: 0.8;">Место в рейтинге</div>
            <div style="font-size: 1.8rem; font-weight: 700; color: var(--warning-orange);" id="statsRank">-</div>
          </div>
        </div>
        
        <h3 style="margin: 20px 0 10px;"><i class="fas fa-history"></i> История получения баллов</h3>
        <div id="pointsHistory" style="max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
          <!-- Заполнится динамически -->
        </div>
        
        <h3 style="margin: 20px 0 10px;"><i class="fas fa-check-circle"></i> Пройденные карточки</h3>
        <div id="completedCardsList" style="max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
          <!-- Заполнится динамически -->
        </div>
      </div>
      
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeModal('studentStatsModal')" style="width: 100%;">
          <i class="fas fa-times"></i> Закрыть
        </button>
      </div>
    </div>
  </div>

  <!-- Панель учителя -->
  <div id="teacherDashboard" class="admin-dashboard">
    <div class="admin-header">
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="width: 40px; height: 40px; background: var(--accent-gradient); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-light);">
          <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div>
          <div style="font-weight: 700;" id="teacherName">Учитель</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Панель учителя</div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="openTeacherChat()">
          <i class="fas fa-comments"></i> Чат учеников
        </button>
        <button class="btn btn-secondary" onclick="openLeaderboard()">
          <i class="fas fa-trophy"></i> Лидеры
        </button>
        <button class="btn btn-danger" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Выйти
        </button>
      </div>
    </div>

    <div class="admin-container">
      <div class="admin-panel">
        <h2><i class="fas fa-layer-group"></i> Выдать карточки ученикам</h2>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
          <select id="teacherClassSelect" style="min-width: 200px;">
            <option value="">Выберите группу</option>
            <option value="5a">Группа 3</option>
            <option value="5b">Группа 4</option>
            <option value="6a">Группа 5</option>
          </select>
          <button class="btn btn-secondary" onclick="loadCardsForTeacher()">
            <i class="fas fa-sync"></i> Обновить
          </button>
        </div>

        <div id="teacherCardsGrid" class="grid">
          <!-- Карточки будут загружены динамически -->
        </div>
      </div>
    </div>
  </div>

  <!-- Панель ученика -->
  <div id="studentDashboard" class="admin-dashboard">
    <div class="admin-header">
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="width: 40px; height: 40px; background: var(--accent-gradient); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-light);">
          <i class="fas fa-user-graduate"></i>
        </div>
        <div>
          <div style="font-weight: 700;" id="studentName">Ученик</div>
          <div style="font-size: 0.9rem; opacity: 0.8;">Панель ученика</div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-secondary" onclick="openChat()">
          <i class="fas fa-comments"></i> Чат
        </button>
        <button class="btn btn-secondary" onclick="openLeaderboard()">
          <i class="fas fa-trophy"></i> Лидеры
        </button>
        <button class="btn btn-danger" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Выйти
        </button>
      </div>
    </div>

    <div class="admin-container">
      <div class="admin-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;"><i class="fas fa-layer-group"></i> Мои карточки</h2>
          <div style="text-align: right;">
            <div style="font-size: 0.9rem; color: var(--text-light);">Мои баллы</div>
            <div style="font-size: 2rem; font-weight: 800; color: var(--primary-blue);" id="studentPoints">0</div>
          </div>
        </div>
        
        <div id="studentCardsGrid" class="grid">
          <!-- Карточки будут загружены динамически -->
        </div>
      </div>
    </div>
  </div>

  <!-- Чат между учениками -->
  <div id="chatModal" class="modal">
    <div class="modal-content" style="max-width: 600px; height: 600px; display: flex; flex-direction: column;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2><i class="fas fa-comments"></i> Чат учеников</h2>
        <button class="close-btn" onclick="closeChat()" style="position: static;">×</button>
      </div>
      
      <div id="chatMessages" style="flex: 1; overflow-y: auto; background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
        <!-- Сообщения будут добавляться динамически -->
      </div>
      
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <button class="btn btn-secondary" onclick="callRex()" style="flex: 0 0 auto;">
          <i class="fas fa-robot"></i> Позвать Rex
        </button>
        <span style="font-size: 0.85rem; color: var(--text-light); opacity: 0.7; display: flex; align-items: center;">
          💡 Или просто упомяни "Rex" в сообщении
        </span>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <input type="text" id="chatInput" placeholder="Введите сообщение..." style="flex: 1;" onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="btn btn-primary" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i> Отправить
        </button>
      </div>
    </div>
  </div>

  <!-- Модальное окно создания карточки (для админа) -->
  <div id="createCardModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-plus"></i> Создать карточку</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Название карточки</label>
        <input type="text" id="cardTitle" style="width: 100%;" placeholder="Например: Математика - Сложение">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Описание</label>
        <textarea id="cardDescription" style="width: 100%; height: 80px;" placeholder="Краткое описание карточки"></textarea>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">URL картинки</label>
        <input type="text" id="cardImageUrl" style="width: 100%;" placeholder="https://example.com/image.jpg">
        <div style="margin-top: 10px;">
          <img id="cardImagePreview" style="max-width: 100%; max-height: 200px; border-radius: 10px; display: none;">
        </div>
        <button class="btn btn-secondary" onclick="previewCardImage()" style="margin-top: 10px; padding: 8px 16px;">
          <i class="fas fa-eye"></i> Предпросмотр
        </button>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Предмет</label>
        <select id="cardSubject" style="width: 100%;">
          <option value="russian">Русский язык</option>
          <option value="math">Математика</option>
          <option value="world">Окружающий мир</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Класс</label>
        <select id="cardGrade" style="width: 100%;">
          <option value="5">5 класс</option>
          <option value="6">6 класс</option>
          <option value="7">7 класс</option>
          <option value="8">8 класс</option>
          <option value="9">9 класс</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Баллы за прохождение</label>
        <input type="number" id="cardPoints" style="width: 100%;" placeholder="10" value="10" min="1" max="100">
        <small style="opacity: 0.7;">Сколько баллов получит ученик за прохождение этой карточки</small>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-success" onclick="saveCard()" style="flex: 1;">
          <i class="fas fa-save"></i> Сохранить
        </button>
        <button class="btn btn-secondary" onclick="closeModal('createCardModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <!-- Модальное окно таблицы лидеров -->
  <div id="leaderboardModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;"><i class="fas fa-trophy"></i> Таблица лидеров</h2>
        <button class="close-btn" onclick="closeModal('leaderboardModal')" style="position: static;">×</button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="showLeaderboardTab('students')" id="leaderboardStudentsBtn">
          <i class="fas fa-user-graduate"></i> Ученики
        </button>
        <button class="btn btn-secondary" onclick="showLeaderboardTab('classes')" id="leaderboardClassesBtn">
          <i class="fas fa-users"></i> Классы
        </button>
      </div>
      
      <!-- Таблица учеников -->
      <div id="leaderboardStudents">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 60px;">Место</th>
              <th>Ученик</th>
              <th>Группа</th>
              <th>Баллы</th>
              <th>Карточек пройдено</th>
            </tr>
          </thead>
          <tbody id="leaderboardStudentsTable">
            <!-- Заполнится динамически -->
          </tbody>
        </table>
      </div>
      
      <!-- Таблица классов -->
      <div id="leaderboardClasses" style="display: none;">
        <table class="data-table">
          <thead>
            <tr>
              <th style="width: 60px;">Место</th>
              <th>Группа</th>
              <th>Баллы</th>
              <th>Учеников</th>
              <th>Средний балл</th>
            </tr>
          </thead>
          <tbody id="leaderboardClassesTable">
            <!-- Заполнится динамически -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Модальные окна -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-user-plus"></i> Добавить пользователя</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Логин</label>
        <input type="text" id="newUserLogin" style="width: 100%;" placeholder="Придумайте логин">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Пароль</label>
        <input type="password" id="newUserPassword" style="width: 100%;" placeholder="Введите пароль">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Имя и фамилия</label>
        <input type="text" id="newUserName" style="width: 100%;" placeholder="Иван Иванов">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Email</label>
        <input type="email" id="newUserEmail" style="width: 100%;" placeholder="ivan@example.com">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Роль</label>
        <select id="newUserRole" style="width: 100%;" onchange="toggleClassField()">
          <option value="student">Ученик</option>
          <option value="teacher">Учитель</option>
          <option value="admin">Администратор</option>
        </select>
      </div>
      
      <div id="classFieldDiv" style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Класс</label>
        <input type="text" id="newUserClass" placeholder="Например: 5А, 10Б, 11В" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="addNewUser()" style="flex: 1;">
          <i class="fas fa-check"></i> Создать
        </button>
        <button class="btn btn-secondary" onclick="closeModal('addUserModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <div id="importUsersModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-file-import"></i> Импорт пользователей</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Формат файла</label>
        <select id="importFormat" style="width: 100%;">
          <option value="csv">CSV (через запятую)</option>
          <option value="json">JSON</option>
          <option value="excel">Excel</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Загрузить файл</label>
        <div class="file-upload-area" onclick="document.getElementById('importFileInput').click()">
          <i class="fas fa-file-upload"></i>
          <h4>Выберите файл для импорта</h4>
          <p style="opacity: 0.7; margin-top: 10px;">CSV, JSON или Excel файл</p>
          <input type="file" id="importFileInput" style="display: none;" onchange="handleImportFile(this.files)">
        </div>
        <div id="importFileName" style="margin-top: 10px; font-size: 0.9rem; color: var(--text-light); opacity: 0.8;"></div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Параметры импорта</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <label>
            <input type="checkbox" id="importUpdateExisting" checked>
            Обновлять существующих пользователей
          </label>
          <label>
            <input type="checkbox" id="importSendWelcomeEmail">
            Отправить приветственное письмо
          </label>
        </div>
      </div>
      
      <div id="importPreview" style="margin-bottom: 20px; display: none;">
        <h4>Предпросмотр данных</h4>
        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
          <div id="importPreviewContent"></div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-success" onclick="processImport()" style="flex: 1;">
          <i class="fas fa-upload"></i> Импортировать
        </button>
        <button class="btn btn-secondary" onclick="closeModal('importUsersModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <div id="massNotificationModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-bullhorn"></i> Массовое уведомление</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Получатели</label>
        <select id="notificationRecipients" style="width: 100%;">
          <option value="all">Все пользователи</option>
          <option value="teachers">Только учителя</option>
          <option value="students">Только ученики</option>
          <option value="admins">Только администраторы</option>
          <option value="selected">Выбранные пользователи</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Тип уведомления</label>
        <select id="notificationType" style="width: 100%;">
          <option value="info">Информационное</option>
          <option value="warning">Предупреждение</option>
          <option value="important">Важное сообщение</option>
          <option value="update">Обновление системы</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Заголовок</label>
        <input type="text" id="notificationTitle" style="width: 100%;" placeholder="Заголовок уведомления">
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Сообщение</label>
        <textarea id="notificationMessage" style="width: 100%; height: 150px;" placeholder="Текст уведомления..."></textarea>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Способы отправки</label>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <label>
            <input type="checkbox" id="notificationEmail" checked>
            Email
          </label>
          <label>
            <input type="checkbox" id="notificationPush">
            Push-уведомление
          </label>
          <label>
            <input type="checkbox" id="notificationSMS">
            SMS
          </label>
          <label>
            <input type="checkbox" id="notificationInApp" checked>
            В приложении
          </label>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="sendMassNotification()" style="flex: 1;">
          <i class="fas fa-paper-plane"></i> Отправить
        </button>
        <button class="btn btn-secondary" onclick="closeModal('massNotificationModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <div id="emergencyModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px; color: var(--danger-red);">
        <i class="fas fa-exclamation-triangle"></i> Аварийное отключение
      </h2>
      
      <div style="background: rgba(255, 77, 109, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255, 77, 109, 0.3);">
        <p><strong>Внимание!</strong> Это действие приведёт к:</p>
        <ul style="margin-top: 10px; padding-left: 20px;">
          <li>Немедленному выходу всех пользователей</li>
          <li>Отключению сайта для всех ролей</li>
          <li>Прерыванию всех текущих сессий</li>
          <li>Временной недоступности системы</li>
        </ul>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Причина отключения</label>
        <select id="shutdownReason" style="width: 100%;">
          <option value="maintenance">Техническое обслуживание</option>
          <option value="security">Проблемы с безопасностью</option>
          <option value="update">Обновление системы</option>
          <option value="emergency">Чрезвычайная ситуация</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Комментарий</label>
        <textarea id="shutdownComment" style="width: 100%; min-height: 80px;" placeholder="Опишите причину отключения..."></textarea>
      </div>
      
      <div style="display: flex; gap: 10px; flex-direction: column;">
        <button class="btn btn-danger" onclick="emergencyShutdown()">
          <i class="fas fa-power-off"></i> Подтвердить отключение
        </button>
        <button class="btn btn-success" onclick="enableSystem()">
          <i class="fas fa-play"></i> Включить систему
        </button>
        <button class="btn btn-secondary" onclick="closeModal('emergencyModal')">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <div id="reportModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;"><i class="fas fa-file-pdf"></i> Создание отчёта</h2>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Тип отчёта</label>
        <select id="reportType" style="width: 100%;">
          <option value="users">Отчёт по пользователям</option>
          <option value="activity">Отчёт по активности</option>
          <option value="academic">Учебная успеваемость</option>
          <option value="system">Системный отчёт</option>
          <option value="financial">Финансовый отчёт</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Период</label>
        <div style="display: flex; gap: 10px;">
          <input type="date" id="reportDateFrom" style="flex: 1;">
          <input type="date" id="reportDateTo" style="flex: 1;">
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Формат отчёта</label>
        <div style="display: flex; gap: 15px;">
          <label>
            <input type="radio" name="reportFormat" value="pdf" checked>
            PDF
          </label>
          <label>
            <input type="radio" name="reportFormat" value="excel">
            Excel
          </label>
          <label>
            <input type="radio" name="reportFormat" value="html">
            HTML
          </label>
          <label>
            <input type="radio" name="reportFormat" value="csv">
            CSV
          </label>
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px;">Дополнительные параметры</label>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <label>
            <input type="checkbox" id="reportIncludeCharts" checked>
            Включать графики
          </label>
          <label>
            <input type="checkbox" id="reportIncludeDetails" checked>
            Подробные данные
          </label>
          <label>
            <input type="checkbox" id="reportIncludeSummary">
            Итоговая сводка
          </label>
          <label>
            <input type="checkbox" id="reportIncludeRecommendations">
            Рекомендации
          </label>
        </div>
      </div>
      
      <div id="reportGeneration" style="display: none; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
          <span>Генерация отчёта...</span>
          <span id="reportPercentage">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="reportProgressBar" style="width: 0%"></div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="generateReportNow()" style="flex: 1;">
          <i class="fas fa-cogs"></i> Создать отчёт
        </button>
        <button class="btn btn-secondary" onclick="closeModal('reportModal')" style="flex: 1;">
          <i class="fas fa-times"></i> Отмена
        </button>
      </div>
    </div>
  </div>

  <script>
    // Глобальные переменные
    let currentUser = null;
    let currentRole = null;
    let systemStatus = {
      teachers: true,
      students: true,
      site: true
    };
    
    let currentPage = 1;
    const itemsPerPage = 10;
    let allUsers = [];
    let filteredUsers = [];
    let selectedFiles = new Set();
    let currentFolderPath = '/';
    
    // Данные файлов
    const defaultFiles = [
      { 
        id: 1, 
        name: 'Материалы', 
        type: 'folder', 
        size: '15 файлов', 
        date: '12.01.2024', 
        path: '/', 
        icon: 'folder', 
        color: '#ff9e00',
        realSize: 0
      },
      { 
        id: 2, 
        name: 'Учебник.pdf', 
        type: 'document', 
        size: '12.5 MB', 
        date: '15.01.2024', 
        path: '/', 
        icon: 'file-pdf', 
        color: '#e63946',
        realSize: 12.5
      },
      { 
        id: 3, 
        name: 'Задания.docx', 
        type: 'document', 
        size: '2.1 MB', 
        date: '14.01.2024', 
        path: '/', 
        icon: 'file-word', 
        color: '#2b579a',
        realSize: 2.1
      },
      { 
        id: 4, 
        name: 'Диаграмма.png', 
        type: 'image', 
        size: '4.7 MB', 
        date: '13.01.2024', 
        path: '/', 
        icon: 'file-image', 
        color: '#9d4edd',
        realSize: 4.7
      },
      { 
        id: 5, 
        name: 'Тесты', 
        type: 'folder', 
        size: '8 файлов', 
        date: '12.01.2024', 
        path: '/', 
        icon: 'folder', 
        color: '#4cc9a0',
        realSize: 0
      },
      { 
        id: 6, 
        name: 'Урок.mp4', 
        type: 'video', 
        size: '45.2 MB', 
        date: '11.01.2024', 
        path: '/', 
        icon: 'file-video', 
        color: '#f72585',
        realSize: 45.2
      }
    ];

    // Данные контента
    const defaultContent = {
      cards: 12,
      assignments: 24,
      tests: 8,
      categories: 5
    };

    // Инициализация системы
    function initSystem() {
      console.log('Инициализация системы...');
      
      if (!localStorage.getItem('system_initialized')) {
        console.log('Первая инициализация системы');
        
        const initialData = {
          users: {
            'admin': {
              login: 'admin',
              password: 'admin123',
              name: 'Главный администратор',
              email: 'admin@uchis.ru',
              role: 'admin',
              created: new Date().toISOString(),
              status: 'active',
              lastLogin: new Date().toISOString()
            },
            'teacher': {
              login: 'teacher',
              password: 'teacher123',
              name: 'Анна Ивановна',
              email: 'teacher@uchis.ru',
              role: 'teacher',
              created: new Date().toISOString(),
              status: 'active',
              lastLogin: new Date().toISOString()
            },
            'student': {
              login: 'student',
              password: 'student123',
              name: 'Иван Петров',
              email: 'student@uchis.ru',
              role: 'student',
              created: new Date().toISOString(),
              status: 'active',
              lastLogin: new Date().toISOString()
            }
          },
          files: defaultFiles,
          content: defaultContent,
          logs: [],
          settings: {
            siteName: 'учись.ру',
            language: 'ru',
            sessionTimeout: 60,
            requireStrongPassword: true,
            blockAfterAttempts: true,
            twoFactorAuth: false,
            emailNotifications: true,
            pushNotifications: false,
            smsNotifications: false,
            autoBackup: 'daily',
            storageLimit: 1000
          }
        };

        Object.keys(initialData).forEach(key => {
          localStorage.setItem(key, JSON.stringify(initialData[key]));
        });

        localStorage.setItem('system_initialized', 'true');
        addLog('system', 'info', 'Система инициализирована');
        
        console.log('Система инициализирована с начальными данными');
      }

      // Загружаем статус системы
      const savedStatus = localStorage.getItem('systemStatus');
      if (savedStatus) {
        systemStatus = JSON.parse(savedStatus);
      }

      updateStatusDisplay();
      loadRecentActivity();
      
      // Обновляем статистику на главной
      updateAdminStats();
      
      console.log('Система готова к работе');
    }

    // Обновление статуса
    function updateStatusDisplay() {
      const teacherCard = document.getElementById('teacherCard');
      const studentCard = document.getElementById('studentCard');
      const toggleTeachers = document.getElementById('toggleTeachers');
      const toggleStudents = document.getElementById('toggleStudents');

      if (teacherCard) teacherCard.classList.toggle('disabled', !systemStatus.teachers);
      if (studentCard) studentCard.classList.toggle('disabled', !systemStatus.students);
      if (toggleTeachers) toggleTeachers.checked = systemStatus.teachers;
      if (toggleStudents) toggleStudents.checked = systemStatus.students;

      const globalStatus = document.getElementById('globalStatus');
      if (globalStatus) {
        const isOnline = systemStatus.site;
        globalStatus.className = `site-status status-${isOnline ? 'online' : 'offline'}`;
        globalStatus.innerHTML = `<i class="fas fa-circle"></i> ${isOnline ? 'Сайт работает' : 'Сайт отключен'}`;
      }
    }

    // Включение/выключение доступа
    function toggleAccess(role) {
      if (role === 'teachers') {
        systemStatus.teachers = !systemStatus.teachers;
        document.getElementById('toggleTeachers').checked = systemStatus.teachers;
        addLog('admin', 'warning', `Доступ для учителей ${systemStatus.teachers ? 'включён' : 'выключен'}`);
      } else if (role === 'students') {
        systemStatus.students = !systemStatus.students;
        document.getElementById('toggleStudents').checked = systemStatus.students;
        addLog('admin', 'warning', `Доступ для учеников ${systemStatus.students ? 'включён' : 'выключен'}`);
      }

      systemStatus.site = systemStatus.teachers || systemStatus.students;
      localStorage.setItem('systemStatus', JSON.stringify(systemStatus));
      updateStatusDisplay();
      
      const message = role === 'teachers' 
        ? `Доступ для учителей ${systemStatus.teachers ? 'включён' : 'выключен'}`
        : `Доступ для учеников ${systemStatus.students ? 'включён' : 'выключен'}`;
      
      showNotification(message, systemStatus[role] ? 'success' : 'warning');
    }

    // Вход в систему
    function openLogin(role) {
      console.log(`Открытие формы входа для роли: ${role}`);
      
      if ((role === 'teacher' && !systemStatus.teachers) || 
          (role === 'student' && !systemStatus.students)) {
        showNotification(`Доступ для ${role === 'teacher' ? 'учителей' : 'учеников'} отключён`, 'error');
        return;
      }

      currentRole = role;
      const modal = document.getElementById('loginModal');
      const title = document.getElementById('modalTitle');
      
      const roleNames = {
        'teacher': 'Учитель',
        'student': 'Ученик', 
        'admin': 'Администратор'
      };
      
      title.textContent = `Вход как ${roleNames[role]}`;
      modal.classList.add('active');
      
      document.getElementById('loginInput').value = '';
      document.getElementById('passwordInput').value = '';
      document.getElementById('rememberMe').checked = false;
      
      // Показываем форму входа, скрываем восстановление
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('passwordResetForm').classList.remove('active');
      
      // Фокус на поле логина
      setTimeout(() => {
        document.getElementById('loginInput').focus();
      }, 100);
    }

    function closeLogin() {
      document.getElementById('loginModal').classList.remove('active');
    }

    function performLogin() {
      const login = document.getElementById('loginInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      
      if (!login || !password) {
        showNotification('Введите логин и пароль', 'error');
        return;
      }
      
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[login];
      
      if (!user || user.password !== password) {
        showNotification('Неверный логин или пароль', 'error');
        addLog('auth', 'warning', `Неудачная попытка входа: ${login}`);
        return;
      }
      
      if (user.role !== currentRole) {
        showNotification(`Этот пользователь не является ${getRoleName(currentRole)}`, 'error');
        return;
      }
      
      if ((user.role === 'teacher' && !systemStatus.teachers) || 
          (user.role === 'student' && !systemStatus.students)) {
        showNotification('Доступ для вашей роли отключён администратором', 'error');
        return;
      }
      
      // Обновляем время последнего входа
      user.lastLogin = new Date().toISOString();
      localStorage.setItem('users', JSON.stringify(users));
      
      currentUser = {
        login: login,
        name: user.name,
        role: user.role,
        email: user.email,
        class: user.class || '5a'
      };
      
      if (rememberMe) {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
      } else {
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
      }
      
      addLog('auth', 'info', `Пользователь ${login} вошёл в систему как ${user.role}`);
      closeLogin();
      
      document.getElementById('loginPage').style.display = 'none';
      
      if (user.role === 'admin') {
        document.getElementById('adminDashboard').classList.add('active');
        loadAdminDashboard();
      } else if (user.role === 'teacher') {
        document.getElementById('teacherDashboard').classList.add('active');
        loadTeacherDashboard();
      } else if (user.role === 'student') {
        document.getElementById('studentDashboard').classList.add('active');
        loadStudentDashboard();
        // ПРИНУДИТЕЛЬНО показываем кнопку Рекс
        setTimeout(() => {
          const rexBtn = document.getElementById('rexButton');
          if (rexBtn) {
            rexBtn.style.display = 'flex';
            console.log('Кнопка Рекс показана!');
          } else {
            console.error('Кнопка Рекс не найдена!');
          }
        }, 100);
      }
      
      showNotification(`Добро пожаловать, ${user.name}!`, 'success');
    }

    function logout() {
      if (currentUser) {
        addLog('auth', 'info', `Пользователь ${currentUser.login} вышел из системы`);
      }
      
      currentUser = null;
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('currentUser');
      
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('loginModal').classList.remove('active');
      document.getElementById('adminDashboard').classList.remove('active');
      document.getElementById('teacherDashboard')?.classList.remove('active');
      document.getElementById('studentDashboard')?.classList.remove('active');
      
      // Скрыть кнопку Рекс
      const rexButton = document.getElementById('rexButton');
      if (rexButton) rexButton.style.display = 'none';
      const rexChat = document.getElementById('rexChat');
      if (rexChat) rexChat.classList.remove('active');
      
      showNotification('Вы вышли из системы', 'info');
    }

    // Восстановление пароля
    function showPasswordReset() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('passwordResetForm').classList.add('active');
    }

    function showLoginForm() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('passwordResetForm').classList.remove('active');
    }

    function resetPassword() {
      const email = document.getElementById('resetEmail').value.trim();
      
      if (!email) {
        showNotification('Введите email для восстановления', 'error');
        return;
      }
      
      // Проверяем существование email в системе
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = Object.values(users).find(u => u.email === email);
      
      if (!user) {
        showNotification('Пользователь с таким email не найден', 'error');
        return;
      }
      
      // Генерируем временный пароль
      const tempPassword = Math.random().toString(36).slice(-10) + 'A1!';
      
      // Обновляем пароль пользователя
      users[user.login].password = tempPassword;
      localStorage.setItem('users', JSON.stringify(users));
      
      // Имитация отправки email
      addLog('auth', 'info', `Запрошено восстановление пароля для ${email}`);
      
      showNotification(`На ${email} отправлена ссылка для восстановления пароля. Временный пароль: ${tempPassword}`, 'success');
      showLoginForm();
    }

    // Загрузка дашборда
    function loadAdminDashboard() {
      console.log('Загрузка дашборда администратора');
      updateAdminStats();
      loadUsersTable();
      loadFilesGrid();
      loadSystemLogs();
      loadSettings();
      updateContentStats();
    }

    function updateAdminStats() {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const files = JSON.parse(localStorage.getItem('files') || defaultFiles);
      
      let teacherCount = 0;
      let studentCount = 0;
      let adminCount = 0;
      
      Object.values(users).forEach(user => {
        if (user.role === 'teacher') teacherCount++;
        if (user.role === 'student') studentCount++;
        if (user.role === 'admin') adminCount++;
      });
      
      document.getElementById('totalUsers').textContent = Object.keys(users).length;
      document.getElementById('teacherCount').textContent = teacherCount;
      document.getElementById('studentCount').textContent = studentCount;
      document.getElementById('totalFiles').textContent = files.length;
      
      const foldersCount = files.filter(f => f.type === 'folder').length;
      const materialsCount = files.filter(f => f.type !== 'folder').length;
      document.getElementById('foldersCount').textContent = foldersCount;
      document.getElementById('materialsCount').textContent = materialsCount;
      
      const activity = Math.floor(Math.random() * 100);
      document.getElementById('dailyActivity').textContent = activity;
      document.getElementById('activityProgress').style.width = activity + '%';
      
      const status = systemStatus.site ? '100%' : '0%';
      document.getElementById('systemStatus').textContent = status;
      const statusIndicator = document.getElementById('statusIndicator');
      if (statusIndicator) {
        statusIndicator.className = `site-status status-${systemStatus.site ? 'online' : 'offline'}`;
        statusIndicator.innerHTML = `<i class="fas fa-circle"></i> ${systemStatus.site ? 'Все системы работают' : 'Система отключена'}`;
      }
    }

    // Управление пользователями
    function loadUsersTable() {
      console.log('Загрузка таблицы пользователей');
      
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const tbody = document.getElementById('usersTable');
      
      if (!tbody) return;
      
      tbody.innerHTML = '';
      
      // Преобразуем объект в массив
      allUsers = Object.values(users).map(user => ({ ...user }));
      filteredUsers = [...allUsers];
      
      // Пагинация
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const usersToShow = filteredUsers.slice(startIndex, endIndex);
      
      let userIndex = startIndex;
      
      usersToShow.forEach(user => {
        userIndex++;
        const row = document.createElement('tr');
        const userId = `UID${userIndex.toString().padStart(4, '0')}`;
        const isActive = user.status === 'active';
        const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Никогда';
        
        row.innerHTML = `
          <td><input type="checkbox" class="user-select" data-login="${user.login}"></td>
          <td>${userId}</td>
          <td><strong>${user.login}</strong></td>
          <td>${user.name}</td>
          <td>
            <span class="tag ${user.role === 'admin' ? 'tag-danger' : user.role === 'teacher' ? 'tag-primary' : 'tag-success'}">
              ${getRoleName(user.role, true)}
            </span>
          </td>
          <td>${user.email}</td>
          <td>
            <span class="site-status ${isActive ? 'status-online' : 'status-offline'}" style="padding: 4px 12px; font-size: 0.8rem;">
              ${isActive ? 'Активен' : 'Неактивен'}
            </span>
          </td>
          <td>${lastLogin}</td>
          <td>
            <button class="btn btn-secondary" style="padding: 5px 10px; margin-right: 5px;" onclick="editUser('${user.login}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-warning" style="padding: 5px 10px; margin-right: 5px;" onclick="resetUserPassword('${user.login}')">
              <i class="fas fa-key"></i>
            </button>
            ${user.login !== 'admin' ? `
              <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteUser('${user.login}')">
                <i class="fas fa-trash"></i>
              </button>
            ` : ''}
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Обновляем информацию о пагинации
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      document.getElementById('usersCount').textContent = filteredUsers.length;
      document.getElementById('paginationInfo').textContent = `Страница ${currentPage} из ${totalPages}`;
    }

    function editUser(login) {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const user = users[login];
      
      if (!user) return;
      
      const newName = prompt('Введите новое имя пользователя:', user.name);
      if (newName && newName.trim()) {
        user.name = newName.trim();
        localStorage.setItem('users', JSON.stringify(users));
        loadUsersTable();
        addLog('admin', 'info', `Изменено имя пользователя ${login} на ${newName}`);
        showNotification('Имя пользователя обновлено', 'success');
      }
    }

    function resetUserPassword(login) {
      if (login === 'admin') {
        const newPassword = prompt('Введите новый пароль для администратора:');
        if (newPassword && newPassword.trim()) {
          const users = JSON.parse(localStorage.getItem('users') || '{}');
          users[login].password = newPassword.trim();
          localStorage.setItem('users', JSON.stringify(users));
          addLog('admin', 'warning', `Сброшен пароль для ${login}`);
          showNotification('Пароль обновлён', 'success');
        }
        return;
      }
      
      const newPassword = Math.random().toString(36).slice(-8);
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      users[login].password = newPassword;
      localStorage.setItem('users', JSON.stringify(users));
      
      addLog('admin', 'warning', `Сброшен пароль для ${login}`);
      showNotification(`Новый пароль для ${login}: ${newPassword}`, 'info');
    }

    function deleteUser(login) {
      if (login === 'admin') {
        showNotification('Нельзя удалить главного администратора', 'error');
        return;
      }
      
      if (!confirm(`Вы уверены, что хотите удалить пользователя ${login}?`)) {
        return;
      }
      
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      delete users[login];
      localStorage.setItem('users', JSON.stringify(users));
      
      addLog('admin', 'warning', `Удалён пользователь: ${login}`);
      loadUsersTable();
      updateAdminStats();
      
      showNotification(`Пользователь ${login} удалён`, 'success');
    }

    function searchUsers() {
      const searchTerm = document.getElementById('searchUsersInput').value.toLowerCase();
      filteredUsers = allUsers.filter(user => 
        user.login.toLowerCase().includes(searchTerm) ||
        user.name.toLowerCase().includes(searchTerm) ||
        user.email.toLowerCase().includes(searchTerm)
      );
      currentPage = 1;
      loadUsersTable();
    }

    function filterUsers() {
      const roleFilter = document.getElementById('filterRole').value;
      const statusFilter = document.getElementById('filterStatus').value;
      
      filteredUsers = allUsers.filter(user => {
        const roleMatch = !roleFilter || user.role === roleFilter;
        const statusMatch = !statusFilter || user.status === statusFilter;
        return roleMatch && statusMatch;
      });
      
      currentPage = 1;
      loadUsersTable();
    }

    function refreshUsers() {
      loadUsersTable();
      showNotification('Список пользователей обновлён', 'info');
    }

    function selectAllUsers() {
      const selectAll = document.getElementById('selectAllUsers').checked;
      document.querySelectorAll('.user-select').forEach(checkbox => {
        checkbox.checked = selectAll;
      });
    }

    function deleteSelectedUsers() {
      const selected = Array.from(document.querySelectorAll('.user-select:checked'))
        .map(cb => cb.getAttribute('data-login'))
        .filter(login => login !== 'admin');
      
      if (selected.length === 0) {
        showNotification('Выберите пользователей для удаления', 'warning');
        return;
      }
      
      if (!confirm(`Вы уверены, что хотите удалить ${selected.length} пользователей?`)) {
        return;
      }
      
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      selected.forEach(login => {
        delete users[login];
      });
      
      localStorage.setItem('users', JSON.stringify(users));
      addLog('admin', 'warning', `Удалено ${selected.length} пользователей`);
      loadUsersTable();
      updateAdminStats();
      
      showNotification(`Удалено ${selected.length} пользователей`, 'success');
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        loadUsersTable();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        loadUsersTable();
      }
    }

    // Импорт пользователей
    function showImportUsersModal() {
      document.getElementById('importUsersModal').classList.add('active');
    }

    function handleImportFile(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      document.getElementById('importFileName').textContent = `Выбран файл: ${file.name}`;
      
      // Показываем предпросмотр
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById('importPreviewContent').textContent = content.substring(0, 500) + '...';
        document.getElementById('importPreview').style.display = 'block';
      };
      reader.readAsText(file);
    }

    function processImport() {
      showNotification('Импорт пользователей выполнен успешно', 'success');
      addLog('admin', 'info', 'Импортированы пользователи из файла');
      closeModal('importUsersModal');
      loadUsersTable();
    }

    // Добавление пользователя
    function showAddUserModal() {
      document.getElementById('addUserModal').classList.add('active');
      toggleClassField(); // Показываем/скрываем поле класса при открытии
    }

    function toggleClassField() {
      const role = document.getElementById('newUserRole').value;
      const classFieldDiv = document.getElementById('classFieldDiv');
      
      // Показываем поле класса только для учеников
      if (role === 'student') {
        classFieldDiv.style.display = 'block';
      } else {
        classFieldDiv.style.display = 'none';
      }
    }

    function addNewUser() {
      const login = document.getElementById('newUserLogin').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const name = document.getElementById('newUserName').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const role = document.getElementById('newUserRole').value;
      const userClass = document.getElementById('newUserClass').value;
      
      if (!login || !password || !name || !email) {
        showNotification('Заполните все поля', 'error');
        return;
      }
      
      if (role === 'student' && !userClass) {
        showNotification('Выберите группу для ученика', 'error');
        return;
      }
      
      if (password.length < 6) {
        showNotification('Пароль должен содержать минимум 6 символов', 'error');
        return;
      }
      
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      
      if (users[login]) {
        showNotification('Пользователь с таким логином уже существует', 'error');
        return;
      }
      
      users[login] = {
        login: login,
        password: password,
        name: name,
        email: email,
        role: role,
        class: role === 'student' ? userClass : null,
        created: new Date().toISOString(),
        status: 'active',
        lastLogin: null
      };
      
      localStorage.setItem('users', JSON.stringify(users));
      addLog('admin', 'info', `Создан новый пользователь: ${login} (${role}${role === 'student' ? ', класс ' + userClass : ''})`);
      
      loadUsersTable();
      updateAdminStats();
      closeModal('addUserModal');
      
      // Очистить поля формы
      document.getElementById('newUserLogin').value = '';
      document.getElementById('newUserPassword').value = '';
      document.getElementById('newUserName').value = '';
      document.getElementById('newUserEmail').value = '';
      document.getElementById('newUserRole').value = 'student';
      document.getElementById('newUserClass').value = '';
      
      showNotification(`Пользователь ${name} успешно создан`, 'success');
    }

    // Управление файлами
    function loadFilesGrid() {
      console.log('Загрузка сетки файлов');
      
      const files = JSON.parse(localStorage.getItem('files') || defaultFiles);
      const currentFiles = files.filter(file => file.path === currentFolderPath);
      const grid = document.getElementById('filesGrid');
      
      if (!grid) return;
      
      grid.innerHTML = '';
      
      currentFiles.forEach(file => {
        const card = document.createElement('div');
        card.className = `function-card file-item ${selectedFiles.has(file.id) ? 'selected' : ''}`;
        card.setAttribute('data-type', file.type);
        card.setAttribute('data-id', file.id);
        
        const clickHandler = file.type === 'folder' ? 
          `openFolder('${file.name}')` : 
          `selectFile(${file.id})`;
        
        card.setAttribute('onclick', clickHandler);
        
        card.innerHTML = `
          <i class="fas fa-${file.icon}" style="color: ${file.color};"></i>
          <h4>${file.name}</h4>
          <p>${file.type === 'folder' ? 'Папка' : getFileTypeDescription(file.type)}</p>
          <div style="font-size: 0.8rem; color: var(--text-light); opacity: 0.7; margin-top: 10px;">
            ${file.size} • ${file.date}
          </div>
          ${selectedFiles.has(file.id) ? `
            <div style="position: absolute; top: 10px; right: 10px; color: var(--primary-blue);">
              <i class="fas fa-check-circle"></i>
            </div>
          ` : ''}
        `;
        
        grid.appendChild(card);
      });
      
      // Обновляем статистику файлов
      updateFilesStats();
      updateCurrentPath();
    }

    function getFileTypeDescription(type) {
      const descriptions = {
        'document': 'Документ',
        'image': 'Изображение',
        'video': 'Видео',
        'audio': 'Аудио'
      };
      return descriptions[type] || 'Файл';
    }

    function selectFile(fileId) {
      if (selectedFiles.has(fileId)) {
        selectedFiles.delete(fileId);
      } else {
        selectedFiles.add(fileId);
      }
      loadFilesGrid();
    }

    function openFolder(folderName) {
      currentFolderPath = currentFolderPath === '/' ? `/${folderName}` : `${currentFolderPath}/${folderName}`;
      loadFilesGrid();
      showNotification(`Открыта папка: ${folderName}`, 'info');
    }

    function goToParentFolder() {
      if (currentFolderPath === '/') return;
      
      const parts = currentFolderPath.split('/').filter(p => p);
      parts.pop();
      currentFolderPath = parts.length > 0 ? '/' + parts.join('/') : '/';
      loadFilesGrid();
    }

    function updateCurrentPath() {
      document.getElementById('currentPath').textContent = currentFolderPath === '/' ? '/ Файлы' : currentFolderPath;
    }

    function updateFilesStats() {
      const files = JSON.parse(localStorage.getItem('files') || defaultFiles);
      
      const totalFiles = files.length;
      const foldersCount = files.filter(f => f.type === 'folder').length;
      const filesCount = totalFiles - foldersCount;
      
      // Считаем общий размер
      let totalSize = 0;
      files.forEach(file => {
        if (file.realSize) {
          totalSize += file.realSize;
        }
      });
      
      document.getElementById('totalFilesCount').textContent = totalFiles;
      document.getElementById('totalSize').textContent = totalSize.toFixed(1) + ' MB';
      document.getElementById('foldersFilesCount').textContent = `${foldersCount} / ${filesCount}`;
      
      // Прогресс использования хранилища
      const storageLimit = parseInt(localStorage.getItem('storageLimit') || 1000);
      const storagePercentage = Math.min((totalSize / storageLimit) * 100, 100);
      document.getElementById('storageProgress').style.width = storagePercentage + '%';
    }

    function showUploadModal() {
      showNotification('Для загрузки файлов используйте область перетаскивания', 'info');
    }

    function triggerFileUpload() {
      document.getElementById('fileUploadInput').click();
    }

    function handleFileUpload(fileList) {
      if (fileList.length === 0) return;
      
      // Показываем прогресс загрузки
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadPercentage = document.getElementById('uploadPercentage');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadArea = document.getElementById('uploadArea');
      
      uploadArea.style.display = 'none';
      uploadProgress.classList.add('active');
      uploadStatus.textContent = 'Подготовка к загрузке...';
      
      let uploadedCount = 0;
      const totalFiles = fileList.length;
      
      // Имитация загрузки файлов
      Array.from(fileList).forEach((file, index) => {
        setTimeout(() => {
          const progress = Math.round(((index + 1) / totalFiles) * 100);
          uploadPercentage.textContent = `${progress}%`;
          uploadProgressBar.style.width = `${progress}%`;
          uploadStatus.textContent = `Загружается файл ${index + 1} из ${totalFiles}: ${file.name}`;
          
          if (index === totalFiles - 1) {
            setTimeout(() => {
              // Добавляем файлы в систему
              const files = JSON.parse(localStorage.getItem('files') || defaultFiles);
              const storageLimit = parseInt(localStorage.getItem('storageLimit') || 1000);
              
              // Считаем текущий размер
              let currentSize = 0;
              files.forEach(f => {
                if (f.realSize) {
                  currentSize += f.realSize;
                }
              });
              
              Array.from(fileList).forEach((file, idx) => {
                const fileSize = Math.min(file.size / (1024 * 1024), 100); // MB
                
                if (currentSize + fileSize > storageLimit) {
                  showNotification(`Недостаточно места для файла ${file.name}`, 'error');
                  return;
                }
                
                const newFile = {
                  id: files.length + idx + 1,
                  name: file.name,
                  type: getUploadFileType(file),
                  size: (file.size / (1024 * 1024)).toFixed(1) + ' MB',
                  date: new Date().toLocaleDateString(),
                  path: currentFolderPath,
                  icon: getUploadFileIcon(file),
                  color: getUploadFileColor(file),
                  realSize: fileSize
                };
                
                files.push(newFile);
                currentSize += fileSize;
              });
              
              localStorage.setItem('files', JSON.stringify(files));
              
              // Завершение загрузки
              uploadStatus.textContent = 'Загрузка завершена!';
              setTimeout(() => {
                uploadArea.style.display = 'block';
                uploadProgress.classList.remove('active');
                loadFilesGrid();
                updateAdminStats();
                addLog('files', 'info', `Загружено ${fileList.length} файлов`);
                showNotification(`${fileList.length} файлов успешно загружено!`, 'success');
              }, 1000);
            }, 500);
          }
        }, index * 500);
      });
    }

    function getUploadFileType(file) {
      if (file.type.startsWith('image/')) return 'image';
      if (file.type.startsWith('video/')) return 'video';
      if (file.type.startsWith('audio/')) return 'audio';
      if (file.type.includes('pdf')) return 'document';
      if (file.type.includes('word') || file.type.includes('document')) return 'document';
      if (file.type.includes('spreadsheet') || file.type.includes('excel')) return 'document';
      if (file.type.includes('presentation') || file.type.includes('powerpoint')) return 'document';
      return 'document';
    }

    function getUploadFileIcon(file) {
      if (file.type.startsWith('image/')) return 'file-image';
      if (file.type.startsWith('video/')) return 'file-video';
      if (file.type.startsWith('audio/')) return 'file-audio';
      if (file.type.includes('pdf')) return 'file-pdf';
      if (file.type.includes('word') || file.type.includes('document')) return 'file-word';
      if (file.type.includes('spreadsheet') || file.type.includes('excel')) return 'file-excel';
      if (file.type.includes('presentation') || file.type.includes('powerpoint')) return 'file-powerpoint';
      return 'file';
    }

    function getUploadFileColor(file) {
      if (file.type.startsWith('image/')) return '#9d4edd';
      if (file.type.startsWith('video/')) return '#f72585';
      if (file.type.startsWith('audio/')) return '#4cc9a0';
      if (file.type.includes('pdf')) return '#e63946';
      if (file.type.includes('word') || file.type.includes('document')) return '#2b579a';
      if (file.type.includes('spreadsheet') || file.type.includes('excel')) return '#217346';
      if (file.type.includes('presentation') || file.type.includes('powerpoint')) return '#d24726';
      return '#4cc9f0';
    }

    function createNewFolder() {
      const folderName = prompt('Введите название новой папки:', 'Новая папка');
      if (!folderName || !folderName.trim()) return;
      
      const files = JSON.parse(localStorage.getItem('files') || defaultFiles);
      const newFolder = {
        id: files.length + 1,
        name: folderName.trim(),
        type: 'folder',
        size: '0 файлов',
        date: new Date().toLocaleDateString(),
        path: currentFolderPath,
        icon: 'folder',
        color: '#ff9e00',
        realSize: 0
      };
      
      files.push(newFolder);
      localStorage.setItem('files', JSON.stringify(files));
      
      loadFilesGrid();
      addLog('files', 'info', `Создана папка: ${folderName}`);
      showNotification(`Папка "${folderName}" создана`, 'success');
    }

    function deleteSelectedFiles() {
      if (selectedFiles.size === 0) {
        showNotification('Выберите файлы для удаления', 'warning');
        return;
      }
      
      if (!confirm(`Вы уверены, что хотите удалить ${selectedFiles.size} файлов?`)) {
        return;
      }
      
      const files = JSON.parse(localStorage.getItem('files') || defaultFiles);
      const newFiles = files.filter(file => !selectedFiles.has(file.id));
      
      localStorage.setItem('files', JSON.stringify(newFiles));
      selectedFiles.clear();
      
      loadFilesGrid();
      updateAdminStats();
      addLog('files', 'warning', `Удалено ${selectedFiles.size} файлов`);
      showNotification(`Удалено ${selectedFiles.size} файлов`, 'success');
    }

    function downloadSelectedFiles() {
      if (selectedFiles.size === 0) {
        showNotification('Выберите файлы для скачивания', 'warning');
        return;
      }
      
      // Имитация создания архива
      showNotification(`Начинается скачивание ${selectedFiles.size} файлов...`, 'info');
      
      setTimeout(() => {
        // Создаем виртуальный файл для скачивания
        const content = `Архив файлов с платформы учись.ру\nДата создания: ${new Date().toLocaleString()}\nКоличество файлов: ${selectedFiles.size}\n\nСписок файлов:\n`;
        
        const files = JSON.parse(localStorage.getItem('files') || defaultFiles);
        const selectedFileNames = files
          .filter(file => selectedFiles.has(file.id))
          .map(file => `- ${file.name} (${file.size})`)
          .join('\n');
        
        const dataStr = content + selectedFileNames;
        const dataUri = 'data:text/plain;charset=utf-8,' + encodeURIComponent(dataStr);
        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', `файлы_учись.ру_${new Date().toISOString().split('T')[0]}.txt`);
        link.click();
        
        addLog('files', 'info', `Скачано ${selectedFiles.size} файлов`);
        showNotification(`${selectedFiles.size} файлов скачано`, 'success');
      }, 1000);
    }

    function organizeFiles() {
      showNotification('Файлы организованы по папкам', 'success');
      addLog('files', 'info', 'Выполнена организация файлов');
    }

    function sortFiles() {
      const sortBy = document.getElementById('fileSort').value;
      showNotification(`Файлы отсортированы по: ${sortBy}`, 'info');
    }

    function filterFiles() {
      const filterBy = document.getElementById('fileFilter').value;
      showNotification(`Показаны файлы: ${filterBy}`, 'info');
    }

    // Управление контентом
    function updateContentStats() {
      const content = JSON.parse(localStorage.getItem('content') || defaultContent);
      document.getElementById('cardsCount').textContent = content.cards || 0;
      document.getElementById('assignmentsCount').textContent = content.assignments || 0;
    }

    function createNewContent() {
      document.getElementById('contentEditor').classList.add('active');
    }

    function hideContentEditor() {
      document.getElementById('contentEditor').classList.remove('active');
    }

    function saveContent() {
      const title = document.getElementById('contentTitle').value.trim();
      const type = document.getElementById('contentType').value;
      const body = document.getElementById('contentBody').value.trim();
      
      if (!title || !body) {
        showNotification('Заполните все поля', 'error');
        return;
      }
      
      const content = JSON.parse(localStorage.getItem('content') || defaultContent);
      
      // Увеличиваем счетчик соответствующего типа контента
      if (type === 'card') content.cards = (content.cards || 0) + 1;
      else if (type === 'assignment') content.assignments = (content.assignments || 0) + 1;
      else if (type === 'test') content.tests = (content.tests || 0) + 1;
      
      localStorage.setItem('content', JSON.stringify(content));
      
      hideContentEditor();
      updateContentStats();
      addLog('content', 'info', `Создан новый контент: ${title} (${type})`);
      showNotification(`Контент "${title}" создан успешно`, 'success');
    }

    function importContent() {
      showNotification('Контент импортирован успешно', 'success');
      addLog('content', 'info', 'Импортирован контент');
    }

    function organizeContent() {
      showNotification('Контент организован', 'success');
      addLog('content', 'info', 'Организован контент');
    }

    function deleteSelectedContent() {
      showNotification('Выбранный контент удалён', 'success');
      addLog('content', 'warning', 'Удалён контент');
    }

    function manageCards() {
      showNotification('Управление карточками обучения', 'info');
    }

    function manageAssignments() {
      showNotification('Управление заданиями', 'info');
    }

    function showTestEditor() {
      document.getElementById('testEditor').classList.add('active');
    }

    function hideTestEditor() {
      document.getElementById('testEditor').classList.remove('active');
    }

    function addTestQuestion() {
      const questionsDiv = document.getElementById('testQuestions');
      const questionCount = questionsDiv.children.length;
      
      const questionDiv = document.createElement('div');
      questionDiv.className = 'question-item';
      questionDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;';
      
      questionDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong>Вопрос ${questionCount + 1}</strong>
          <button class="btn btn-danger" style="padding: 2px 8px;" onclick="this.parentElement.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <input type="text" placeholder="Текст вопроса" style="width: 100%; margin-bottom: 10px;">
        <input type="text" placeholder="Вариант ответа 1" style="width: 100%; margin-bottom: 5px;">
        <input type="text" placeholder="Вариант ответа 2" style="width: 100%; margin-bottom: 5px;">
        <input type="text" placeholder="Вариант ответа 3" style="width: 100%; margin-bottom: 5px;">
        <input type="text" placeholder="Вариант ответа 4" style="width: 100%; margin-bottom: 10px;">
        <select style="width: 100%;">
          <option value="">Выберите правильный ответ</option>
          <option value="1">Вариант 1</option>
          <option value="2">Вариант 2</option>
          <option value="3">Вариант 3</option>
          <option value="4">Вариант 4</option>
        </select>
      `;
      
      questionsDiv.appendChild(questionDiv);
    }

    function saveTest() {
      const title = document.getElementById('testTitle').value.trim();
      const description = document.getElementById('testDescription').value.trim();
      
      if (!title) {
        showNotification('Введите название теста', 'error');
        return;
      }
      
      const content = JSON.parse(localStorage.getItem('content') || defaultContent);
      content.tests = (content.tests || 0) + 1;
      localStorage.setItem('content', JSON.stringify(content));
      
      hideTestEditor();
      updateContentStats();
      addLog('content', 'info', `Создан новый тест: ${title}`);
      showNotification(`Тест "${title}" создан успешно`, 'success');
    }

    function manageCategories() {
      showNotification('Управление категориями и тегами', 'info');
    }

    function publishContent() {
      showNotification('Контент опубликован', 'success');
      addLog('content', 'info', 'Опубликован контент');
    }

    function contentAnalytics() {
      showNotification('Аналитика контента загружена', 'info');
    }

    // Массовые уведомления
    function showMassNotificationModal() {
      document.getElementById('massNotificationModal').classList.add('active');
    }

    // Отчёты
    function generateReport() {
      document.getElementById('reportModal').classList.add('active');
    }

    function generateReportNow() {
      const reportType = document.getElementById('reportType').value;
      const reportGeneration = document.getElementById('reportGeneration');
      const reportPercentage = document.getElementById('reportPercentage');
      const reportProgressBar = document.getElementById('reportProgressBar');
      
      reportGeneration.style.display = 'block';
      
      // Имитация генерации отчёта
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        reportPercentage.textContent = `${progress}%`;
        reportProgressBar.style.width = `${progress}%`;
        
        if (progress >= 100) {
          clearInterval(interval);
          
          // Создаем отчёт
          const reportTypes = {
            'users': 'Отчёт по пользователям',
            'activity': 'Отчёт по активности',
            'academic': 'Учебная успеваемость',
            'system': 'Системный отчёт',
            'financial': 'Финансовый отчёт'
          };
          
          const reportName = reportTypes[reportType] || 'Отчёт';
          const dataStr = `${reportName}\nСгенерирован: ${new Date().toLocaleString()}\n\nДанные отчёта...`;
          const dataUri = 'data:text/plain;charset=utf-8,' + encodeURIComponent(dataStr);
          const link = document.createElement('a');
          link.setAttribute('href', dataUri);
          link.setAttribute('download', `${reportName.toLowerCase().replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.txt`);
          link.click();
          
          setTimeout(() => {
            reportGeneration.style.display = 'none';
            reportProgressBar.style.width = '0%';
            closeModal('reportModal');
            showNotification('Отчёт успешно создан и скачан', 'success');
            addLog('reports', 'info', `Сгенерирован отчёт: ${reportName}`);
          }, 1000);
        }
      }, 200);
    }

    function exportAnalytics() {
      const dataStr = JSON.stringify({
        timestamp: new Date().toISOString(),
        users: Object.keys(JSON.parse(localStorage.getItem('users') || '{}')).length,
        files: JSON.parse(localStorage.getItem('files') || defaultFiles).length,
        activity: Math.floor(Math.random() * 100),
        stats: 'Данные аналитики'
      }, null, 2);
      
      const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', `analytics_учись.ру_${new Date().toISOString().split('T')[0]}.json`);
      link.click();
      
      addLog('analytics', 'info', 'Экспортированы данные аналитики');
      showNotification('Данные аналитики экспортированы', 'success');
    }

    function refreshAnalytics() {
      showNotification('Аналитика обновлена', 'info');
    }

    // Настройки
    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('settings') || '{}');
      
      if (settings.siteName) document.getElementById('siteName').value = settings.siteName;
      if (settings.language) document.getElementById('siteLanguage').value = settings.language;
      if (settings.sessionTimeout) document.getElementById('sessionTimeout').value = settings.sessionTimeout;
      if (settings.requireStrongPassword) document.getElementById('requireStrongPassword').checked = settings.requireStrongPassword;
      if (settings.blockAfterAttempts) document.getElementById('blockAfterAttempts').checked = settings.blockAfterAttempts;
      if (settings.twoFactorAuth) document.getElementById('twoFactorAuth').checked = settings.twoFactorAuth;
      if (settings.emailNotifications) document.getElementById('emailNotifications').checked = settings.emailNotifications;
      if (settings.pushNotifications) document.getElementById('pushNotifications').checked = settings.pushNotifications;
      if (settings.smsNotifications) document.getElementById('smsNotifications').checked = settings.smsNotifications;
      if (settings.autoBackup) document.getElementById('autoBackup').value = settings.autoBackup;
      if (settings.storageLimit) {
        document.getElementById('storageLimit').value = settings.storageLimit;
        document.getElementById('storageLimitValue').textContent = settings.storageLimit + ' MB';
      }
    }

    function saveSettings() {
      const settings = {
        siteName: document.getElementById('siteName').value,
        language: document.getElementById('siteLanguage').value,
        sessionTimeout: parseInt(document.getElementById('sessionTimeout').value) || 60,
        requireStrongPassword: document.getElementById('requireStrongPassword').checked,
        blockAfterAttempts: document.getElementById('blockAfterAttempts').checked,
        twoFactorAuth: document.getElementById('twoFactorAuth').checked,
        emailNotifications: document.getElementById('emailNotifications').checked,
        pushNotifications: document.getElementById('pushNotifications').checked,
        smsNotifications: document.getElementById('smsNotifications').checked,
        autoBackup: document.getElementById('autoBackup').value,
        storageLimit: parseInt(document.getElementById('storageLimit').value) || 1000
      };
      
      localStorage.setItem('settings', JSON.stringify(settings));
      addLog('settings', 'info', 'Настройки системы сохранены');
      showNotification('Настройки успешно сохранены', 'success');
    }

    // Логи
    function loadSystemLogs() {
      const logs = JSON.parse(localStorage.getItem('logs') || '[]');
      const container = document.getElementById('systemLogs');
      
      if (!container) return;
      
      container.innerHTML = '';
      
      logs.slice(-20).reverse().forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        const time = new Date(log.timestamp || Date.now()).toLocaleString();
        
        logEntry.innerHTML = `
          <div style="display: flex; justify-content: space-between;">
            <span class="log-time">${time}</span>
            <span style="color: ${getLogColor(log.level)}; font-weight: 500;">${log.level.toUpperCase()}</span>
          </div>
          <div class="log-action">${log.action}</div>
          <div style="color: var(--text-light); font-size: 0.9rem; margin-top: 5px; opacity: 0.8;">${log.details || ''}</div>
        `;
        
        container.appendChild(logEntry);
      });
    }

    function addLog(category, level, action, details = '') {
      const logs = JSON.parse(localStorage.getItem('logs') || '[]');
      
      logs.push({
        timestamp: new Date().toISOString(),
        category: category,
        level: level,
        action: action,
        details: details,
        user: currentUser ? currentUser.login : 'system'
      });
      
      if (logs.length > 1000) logs.splice(0, logs.length - 1000);
      localStorage.setItem('logs', JSON.stringify(logs));
      
      if (document.getElementById('adminLogsTab')?.classList.contains('active')) {
        loadSystemLogs();
      }
      
      loadRecentActivity();
    }

    function loadRecentActivity() {
      const logs = JSON.parse(localStorage.getItem('logs') || '[]');
      const container = document.getElementById('recentActivity');
      
      if (!container) return;
      
      container.innerHTML = '';
      
      logs.slice(-5).reverse().forEach(log => {
        const activityItem = document.createElement('div');
        activityItem.className = 'log-entry';
        const time = new Date(log.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        activityItem.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${getLogColor(log.level)};"></div>
            <div style="flex: 1;">
              <div style="font-weight: 500;">${log.action}</div>
              <div style="font-size: 0.8rem; opacity: 0.7;">${time} • ${log.user}</div>
            </div>
          </div>
        `;
        
        container.appendChild(activityItem);
      });
    }

    function refreshLogs() {
      loadSystemLogs();
      showNotification('Логи обновлены', 'info');
    }

    function clearLogs() {
      if (!confirm('Вы уверены, что хотите очистить все логи?')) {
        return;
      }
      
      localStorage.setItem('logs', JSON.stringify([]));
      loadSystemLogs();
      addLog('system', 'warning', 'Все логи очищены');
      showNotification('Логи очищены', 'success');
    }

    function filterLogs() {
      const filter = document.getElementById('logFilter').value;
      showNotification(`Логи отфильтрованы по: ${filter}`, 'info');
    }

    function filterLogsByDate() {
      const date = document.getElementById('logDate').value;
      showNotification(`Логи отфильтрованы по дате: ${date}`, 'info');
    }

    function exportLogs() {
      const logs = JSON.parse(localStorage.getItem('logs') || '[]');
      const dataStr = JSON.stringify(logs, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      const fileName = `logs_учись.ру_${new Date().toISOString().split('T')[0]}.json`;
      
      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', fileName);
      link.click();
      
      addLog('system', 'info', 'Экспортированы логи системы');
      showNotification('Логи экспортированы', 'success');
    }

    // Утилиты
    function showEmergencyPanel() {
      document.getElementById('emergencyModal').classList.add('active');
    }

    function createBackup() {
      const data = {
        timestamp: new Date().toISOString(),
        users: JSON.parse(localStorage.getItem('users') || '{}'),
        files: JSON.parse(localStorage.getItem('files') || defaultFiles),
        content: JSON.parse(localStorage.getItem('content') || defaultContent),
        settings: JSON.parse(localStorage.getItem('settings') || '{}'),
        logs: JSON.parse(localStorage.getItem('logs') || '[]')
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      const fileName = `backup_учись.ру_${new Date().toISOString().split('T')[0]}.json`;
      
      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', fileName);
      link.click();
      
      addLog('backup', 'info', 'Создана резервная копия системы');
      showNotification('Резервная копия создана и скачана', 'success');
    }

    function clearSystemCache() {
      localStorage.removeItem('tempData');
      sessionStorage.clear();
      
      addLog('system', 'info', 'Очищен системный кэш');
      showNotification('Системный кэш очищен', 'success');
    }

    // Аварийное отключение и включение системы
    function emergencyShutdown() {
      const reason = document.getElementById('shutdownReason').value;
      const comment = document.getElementById('shutdownComment').value;
      
      systemStatus.teachers = false;
      systemStatus.students = false;
      systemStatus.site = false;
      
      localStorage.setItem('systemStatus', JSON.stringify(systemStatus));
      addLog('admin', 'error', `Аварийное отключение. Причина: ${reason}. Комментарий: ${comment || 'нет'}`);
      
      updateStatusDisplay();
      closeModal('emergencyModal');
      
      showNotification('Система отключена для всех пользователей', 'warning');
    }

    function enableSystem() {
      systemStatus.teachers = true;
      systemStatus.students = true;
      systemStatus.site = true;
      
      localStorage.setItem('systemStatus', JSON.stringify(systemStatus));
      updateStatusDisplay();
      addLog('admin', 'info', 'Система полностью включена');
      showNotification('Система включена для всех пользователей', 'success');
      closeModal('emergencyModal');
    }

    // Другие функции
    function exportUsersData() {
      const users = JSON.parse(localStorage.getItem('users') || '{}');
      const dataStr = JSON.stringify(users, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      const fileName = `users_учись.ру_${new Date().toISOString().split('T')[0]}.json`;
      
      const link = document.createElement('a');
      link.setAttribute('href', dataUri);
      link.setAttribute('download', fileName);
      link.click();
      
      addLog('admin', 'info', 'Экспортированы данные пользователей');
      showNotification('Данные пользователей экспортированы', 'success');
    }

    function generateUserReport() {
      showNotification('Отчёт по пользователям сформирован', 'success');
      addLog('reports', 'info', 'Сформирован отчёт по пользователям');
    }

    // Переключение вкладок
    function switchAdminTab(tabName) {
      // Убираем активный класс у всех кнопок
      document.querySelectorAll('.admin-nav button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Добавляем активный класс нажатой кнопке
      event.target.classList.add('active');
      
      // Скрываем все вкладки
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Показываем нужную вкладку
      const tabId = 'admin' + capitalizeFirst(tabName) + 'Tab';
      const tabElement = document.getElementById(tabId);
      if (tabElement) {
        tabElement.classList.add('active');
      }
      
      // Обновляем данные в зависимости от вкладки
      switch(tabName) {
        case 'dashboard':
          updateAdminStats();
          break;
        case 'users':
          loadUsersTable();
          break;
        case 'files':
          loadFilesGrid();
          break;
        case 'content':
          updateContentStats();
          break;
        case 'logs':
          loadSystemLogs();
          break;
        case 'settings':
          loadSettings();
          break;
      }
    }

    // Вспомогательные функции
    function capitalizeFirst(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function getRoleName(role, capitalize = false) {
      const names = {
        'teacher': 'Учитель',
        'student': 'Ученик', 
        'admin': 'Администратор'
      };
      
      const name = names[role] || role;
      return capitalize ? name : name.toLowerCase();
    }

    function getLogColor(level) {
      const colors = {
        'info': '#4cc9f0',
        'warning': '#ff9e00',
        'error': '#ff4d6d',
        'security': '#9d4edd'
      };
      return colors[level] || '#cdd6f7';
    }

    function showNotification(message, type = 'info') {
      // Удаляем старые уведомления
      document.querySelectorAll('.notification').forEach(n => n.remove());
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}" 
           style="color: ${type === 'success' ? '#4cc9a0' : type === 'error' ? '#ff4d6d' : type === 'warning' ? '#ff9e00' : '#4cc9f0'}"></i>
        <div>${message}</div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function toggleAccordion(element) {
      element.classList.toggle('active');
    }

    // Drag and drop для файлов
    function setupDragAndDrop() {
      const uploadArea = document.getElementById('uploadArea');
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-blue)';
        uploadArea.style.background = 'rgba(76, 201, 240, 0.1)';
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = 'rgba(76, 201, 240, 0.3)';
        uploadArea.style.background = '';
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'rgba(76, 201, 240, 0.3)';
        uploadArea.style.background = '';
        
        if (e.dataTransfer.files.length) {
          handleFileUpload(e.dataTransfer.files);
        }
      });
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM загружен, инициализация...');
      
      initSystem();
      setupDragAndDrop();
      
      // Назначаем обработчики для кнопок в модальных окнах
      document.querySelectorAll('.modal-content .btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
        });
      });
      
      // Обработчик закрытия модальных окон по клику вне контента
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.remove('active');
          }
        });
      });
      
      // Обработчики для переключателей
      document.querySelectorAll('.toggle-switch input').forEach(switchEl => {
        switchEl.addEventListener('change', function(e) {
          e.stopPropagation();
          const role = this.id === 'toggleTeachers' ? 'teachers' : 'students';
          toggleAccess(role);
        });
      });
      
      // Обновление значения лимита хранилища
      const storageLimit = document.getElementById('storageLimit');
      const storageLimitValue = document.getElementById('storageLimitValue');
      if (storageLimit && storageLimitValue) {
        storageLimit.addEventListener('input', function() {
          storageLimitValue.textContent = this.value + ' MB';
          localStorage.setItem('storageLimit', this.value);
        });
      }
      
      // Проверка сохранённого пользователя
      const savedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          if (currentUser.role === 'admin') {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminDashboard').classList.add('active');
            loadAdminDashboard();
            showNotification(`С возвращением, ${currentUser.name}!`, 'success');
          } else if (currentUser.role === 'student') {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('studentDashboard').classList.add('active');
            loadStudentDashboard();
            showNotification(`С возвращением, ${currentUser.name}!`, 'success');
            // ПРИНУДИТЕЛЬНО показываем кнопку Рекс
            setTimeout(() => {
              const rexBtn = document.getElementById('rexButton');
              if (rexBtn) {
                rexBtn.style.display = 'flex';
                console.log('Кнопка Рекс показана при восстановлении сессии!');
              }
            }, 300);
          } else if (currentUser.role === 'teacher') {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('teacherDashboard').classList.add('active');
            loadTeacherDashboard();
            showNotification(`С возвращением, ${currentUser.name}!`, 'success');
          }
        } catch (e) {
          console.error('Ошибка при загрузке пользователя:', e);
        }
      }
      
      console.log('Инициализация завершена');
    });

    // Функции для учителя
    function loadTeacherDashboard() {
      console.log('Загрузка панели учителя');
      document.getElementById('teacherName').textContent = currentUser.name;
      loadCardsForTeacher();
    }

    function loadCardsForTeacher() {
      const cards = JSON.parse(localStorage.getItem('cards') || '[]');
      const grid = document.getElementById('teacherCardsGrid');
      
      if (!grid) return;
      
      grid.innerHTML = '';
      
      if (cards.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Нет доступных карточек. Администратор еще не создал карточки.</p>';
        return;
      }
      
      cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'function-card';
        cardEl.style.cursor = 'pointer';
        
        cardEl.innerHTML = `
          ${card.imageUrl ? `<div style="width: 100%; height: 150px; background: url('${card.imageUrl}') center/cover; border-radius: 12px; margin-bottom: 15px;"></div>` : ''}
          <h4>${card.title}</h4>
          <p>${card.description}</p>
          <div style="margin-top: 10px;">
            <span class="tag tag-primary">${card.subject}</span>
            <span class="tag tag-success">${card.grade} класс</span>
          </div>
          <button class="btn btn-primary" onclick="assignCardToClass('${card.id}')" style="margin-top: 15px; width: 100%;">
            <i class="fas fa-share"></i> Выдать классу
          </button>
        `;
        
        grid.appendChild(cardEl);
      });
    }

    function assignCardToClass(cardId) {
      const classSelect = document.getElementById('teacherClassSelect');
      const selectedClass = classSelect.value;
      
      if (!selectedClass) {
        showNotification('Выберите группу', 'error');
        return;
      }
      
      const assignments = JSON.parse(localStorage.getItem('assignments') || '{}');
      if (!assignments[selectedClass]) {
        assignments[selectedClass] = [];
      }
      
      if (!assignments[selectedClass].includes(cardId)) {
        assignments[selectedClass].push(cardId);
        localStorage.setItem('assignments', JSON.stringify(assignments));
        showNotification('Карточка выдана классу', 'success');
        addLog('teacher', 'info', `Карточка ${cardId} выдана классу ${selectedClass}`);
      } else {
        showNotification('Эта карточка уже выдана этому классу', 'warning');
      }
    }

    // Функции для ученика
    function loadStudentDashboard() {
      console.log('Загрузка панели ученика');
      document.getElementById('studentName').textContent = currentUser.name;
      updateStudentPoints();
      loadCardsForStudent();
      loadChatMessages();
      
      // ПРИНУДИТЕЛЬНО показываем кнопку Рекс
      setTimeout(() => {
        const rexBtn = document.getElementById('rexButton');
        if (rexBtn) {
          rexBtn.style.display = 'flex';
          console.log('Кнопка Рекс показана через loadStudentDashboard!');
        } else {
          console.error('Кнопка Рекс не найдена в loadStudentDashboard!');
        }
      }, 200);
    }

    function loadCardsForStudent() {
      const studentClass = currentUser.class || '5a'; // По умолчанию 5А
      const assignments = JSON.parse(localStorage.getItem('assignments') || '{}');
      const assignedCardIds = assignments[studentClass] || [];
      const cards = JSON.parse(localStorage.getItem('cards') || '[]');
      const completedCards = JSON.parse(localStorage.getItem('completedCards') || '{}');
      const userCompletedCards = completedCards[currentUser.login] || [];
      
      const grid = document.getElementById('studentCardsGrid');
      if (!grid) return;
      
      grid.innerHTML = '';
      
      const assignedCards = cards.filter(card => assignedCardIds.includes(card.id));
      
      if (assignedCards.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">Учитель еще не выдал вам карточки.</p>';
        return;
      }
      
      assignedCards.forEach(card => {
        const isCompleted = userCompletedCards.some(item => 
          typeof item === 'object' ? item.cardId === card.id : item === card.id
        );
        
        const cardEl = document.createElement('div');
        cardEl.className = 'function-card';
        cardEl.style.cursor = isCompleted ? 'default' : 'pointer';
        if (isCompleted) {
          cardEl.style.opacity = '0.6';
          cardEl.style.filter = 'grayscale(0.5)';
        } else {
          cardEl.onclick = () => openCard(card.id);
        }
        
        cardEl.innerHTML = `
          ${card.imageUrl ? `<div style="width: 100%; height: 150px; background: url('${card.imageUrl}') center/cover; border-radius: 12px; margin-bottom: 15px; position: relative;">
            ${isCompleted ? '<div style="position: absolute; top: 10px; right: 10px; background: var(--success-green); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;">✓ Пройдено</div>' : ''}
            ${!isCompleted && card.points ? `<div style="position: absolute; bottom: 10px; right: 10px; background: rgba(255, 158, 0, 0.9); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;"><i class="fas fa-star"></i> ${card.points} баллов</div>` : ''}
          </div>` : ''}
          <h4>${card.title}</h4>
          <p>${card.description}</p>
          <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px;">
            <div>
              <span class="tag tag-primary">${card.subject}</span>
              <span class="tag tag-success">${card.grade} класс</span>
              ${isCompleted ? '<span class="tag tag-success">✓ Пройдено</span>' : ''}
            </div>
            ${!isCompleted && card.points ? `<div style="color: var(--warning-orange); font-weight: 700;"><i class="fas fa-star"></i> ${card.points} баллов</div>` : ''}
          </div>
        `;
        
        grid.appendChild(cardEl);
      });
    }

    function openCard(cardId) {
      // Проверяем, не была ли карточка уже пройдена
      const completedCards = JSON.parse(localStorage.getItem('completedCards') || '{}');
      const userKey = currentUser.login;
      
      if (!completedCards[userKey]) {
        completedCards[userKey] = [];
      }
      
      if (completedCards[userKey].some(item => 
        typeof item === 'object' ? item.cardId === cardId : item === cardId
      )) {
        showNotification('Вы уже прошли эту карточку!', 'warning');
        return;
      }
      
      // Получаем карточку и её баллы
      const cards = JSON.parse(localStorage.getItem('cards') || '[]');
      const card = cards.find(c => c.id === cardId);
      const points = card?.points || 10; // По умолчанию 10 баллов
      
      // Сохраняем баллы
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      if (!userPoints[userKey]) {
        userPoints[userKey] = {
          total: 0,
          class: currentUser.class || '5a',
          name: currentUser.name,
          cardsCompleted: 0
        };
      }
      
      userPoints[userKey].total += points;
      userPoints[userKey].cardsCompleted += 1;
      localStorage.setItem('userPoints', JSON.stringify(userPoints));
      
      // Отмечаем карточку как пройденную с датой и баллами
      completedCards[userKey].push({
        cardId: cardId,
        completedDate: new Date().toISOString(),
        pointsEarned: points
      });
      localStorage.setItem('completedCards', JSON.stringify(completedCards));
      
      // Обновляем отображение баллов
      updateStudentPoints();
      
      // Показываем уведомление
      showNotification(`Карточка пройдена! Вы получили ${points} баллов! 🎉`, 'success');
      addLog('student', 'info', `${currentUser.name} прошел карточку и получил ${points} баллов`);
      
      // Перезагружаем карточки
      loadCardsForStudent();
    }
    
    function updateStudentPoints() {
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      const userKey = currentUser.login;
      const points = userPoints[userKey]?.total || 0;
      
      const pointsEl = document.getElementById('studentPoints');
      if (pointsEl) {
        pointsEl.textContent = points;
      }
    }

    // Функции чата
    function openChat() {
      document.getElementById('chatModal').classList.add('active');
      loadChatMessages();
    }

    function closeChat() {
      document.getElementById('chatModal').classList.remove('active');
    }

    function loadChatMessages() {
      const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
      const container = document.getElementById('chatMessages');
      
      if (!container) return;
      
      container.innerHTML = '';
      
      if (messages.length === 0) {
        // Добавляем приветственное сообщение от Rex
        const welcomeMsg = `
          <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, rgba(76, 201, 240, 0.2), rgba(157, 78, 221, 0.2)); border-radius: 12px; border-left: 4px solid var(--primary-purple);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <span style="font-size: 2rem;">🤖</span>
              <strong style="font-size: 1.1rem;">Rex AI</strong>
            </div>
            <p style="margin: 0; line-height: 1.6;">
              Привет! 👋 Я Rex - твой AI-помощник на платформе учись.ру!<br><br>
              Я могу помочь тебе с:<br>
              📚 Объяснением учебных тем<br>
              💡 Подсказками и советами<br>
              ❓ Ответами на вопросы о платформе<br>
              🎯 Мотивацией в учёбе<br><br>
              Просто упомяни меня в сообщении (напиши "Rex" или "Рекс"), и я отвечу! 😊
            </p>
          </div>
        `;
        container.innerHTML = welcomeMsg;
        return;
      }
      
      messages.forEach((msg, index) => {
        const msgEl = document.createElement('div');
        
        // Специальный стиль для Rex
        if (msg.user === 'rex') {
          msgEl.style.cssText = 'margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, rgba(76, 201, 240, 0.15), rgba(157, 78, 221, 0.15)); border-radius: 12px; border-left: 4px solid var(--primary-purple);';
        } else {
          msgEl.style.cssText = 'margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;';
        }
        
        const isOwn = currentUser && msg.user === currentUser.login;
        const isAdmin = currentUser && currentUser.role === 'admin';
        
        if (isOwn && msg.user !== 'rex') {
          msgEl.style.background = 'rgba(76, 201, 240, 0.2)';
        }
        
        msgEl.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <strong>${msg.userName}</strong>
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 0.8rem; opacity: 0.7;">${new Date(msg.timestamp).toLocaleTimeString()}</span>
              ${msg.edited ? '<span style="font-size: 0.7rem; opacity: 0.6; font-style: italic;">(изменено)</span>' : ''}
              ${isAdmin ? `
                <button onclick="editMessage(${index})" class="btn btn-warning" style="padding: 4px 8px; font-size: 0.75rem;">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="deleteMessage(${index})" class="btn btn-danger" style="padding: 4px 8px; font-size: 0.75rem;">
                  <i class="fas fa-trash"></i>
                </button>
              ` : ''}
            </div>
          </div>
          <div id="messageText${index}">${msg.text}</div>
          <div id="messageEdit${index}" style="display: none;">
            <input type="text" id="editInput${index}" value="${msg.text.replace(/"/g, '&quot;')}" style="width: 100%; margin-bottom: 5px;">
            <button onclick="saveEditedMessage(${index})" class="btn btn-success" style="padding: 4px 12px; font-size: 0.8rem; margin-right: 5px;">
              <i class="fas fa-save"></i> Сохранить
            </button>
            <button onclick="cancelEdit(${index})" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.8rem;">
              <i class="fas fa-times"></i> Отмена
            </button>
          </div>
        `;
        
        container.appendChild(msgEl);
      });
      
      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
      
      // Добавляем сообщение пользователя
      messages.push({
        user: currentUser.login,
        userName: currentUser.name,
        text: text,
        timestamp: new Date().toISOString()
      });
      
      localStorage.setItem('chatMessages', JSON.stringify(messages));
      
      input.value = '';
      loadChatMessages();
      
      // Проверяем, обращаются ли к Rex
      if (text.toLowerCase().includes('rex') || text.toLowerCase().includes('полли')) {
        // Показываем индикатор загрузки
        const loadingMsg = {
          user: 'rex',
          userName: '🤖 Rex AI',
          text: '<i class="fas fa-spinner fa-spin"></i> Думаю...',
          timestamp: new Date().toISOString(),
          isLoading: true
        };
        messages.push(loadingMsg);
        localStorage.setItem('chatMessages', JSON.stringify(messages));
        loadChatMessages();
        
        // Получаем ответ от Gemini
        const response = await getRexResponse(text);
        
        // Удаляем сообщение загрузки
        messages.pop();
        
        // Добавляем ответ Rex
        messages.push({
          user: 'rex',
          userName: '🤖 Rex AI',
          text: response,
          timestamp: new Date().toISOString()
        });
        
        localStorage.setItem('chatMessages', JSON.stringify(messages));
        loadChatMessages();
      }
    }
    
    // Функция для получения ответа от Gemini API
    // УМНЫЙ РЕШАТЕЛЬ ЗАДАЧ (БЕЗ API!)
    async function getRexResponse(userMessage) {
      const msg = userMessage.toLowerCase().trim();
      
      // 1. МАТЕМАТИКА - Решение примеров
      const mathPattern = /(\d+\.?\d*)\s*([\+\-\*\/×÷])\s*(\d+\.?\d*)/;
      const mathMatch = msg.match(mathPattern);
      
      if (mathMatch) {
        const num1 = parseFloat(mathMatch[1]);
        const operator = mathMatch[2];
        const num2 = parseFloat(mathMatch[3]);
        let result, explanation;
        
        switch(operator) {
          case '+':
            result = num1 + num2;
            explanation = `${num1} + ${num2} = ${result}`;
            break;
          case '-':
            result = num1 - num2;
            explanation = `${num1} - ${num2} = ${result}`;
            break;
          case '*':
          case '×':
            result = num1 * num2;
            explanation = `${num1} × ${num2} = ${result}`;
            break;
          case '/':
          case '÷':
            if (num2 === 0) return '❌ На ноль делить нельзя!';
            result = num1 / num2;
            explanation = `${num1} ÷ ${num2} = ${result}`;
            break;
        }
        
        return `✅ Ответ: ${result}\n\n📝 Решение:\n${explanation}\n\n💡 Проверь: подставь ответ обратно в пример!`;
      }
      
      // 2. УРАВНЕНИЯ (x + a = b)
      const equationPattern = /x\s*\+\s*(\d+)\s*=\s*(\d+)/;
      const eqMatch = msg.match(equationPattern);
      
      if (eqMatch) {
        const a = parseFloat(eqMatch[1]);
        const b = parseFloat(eqMatch[2]);
        const x = b - a;
        return `✅ Ответ: x = ${x}\n\n📝 Решение:\nx + ${a} = ${b}\nx = ${b} - ${a}\nx = ${x}\n\n✔️ Проверка: ${x} + ${a} = ${b}`;
      }
      
      // 3. УРАВНЕНИЯ (x - a = b)
      const equationPattern2 = /x\s*-\s*(\d+)\s*=\s*(\d+)/;
      const eqMatch2 = msg.match(equationPattern2);
      
      if (eqMatch2) {
        const a = parseFloat(eqMatch2[1]);
        const b = parseFloat(eqMatch2[2]);
        const x = b + a;
        return `✅ Ответ: x = ${x}\n\n📝 Решение:\nx - ${a} = ${b}\nx = ${b} + ${a}\nx = ${x}\n\n✔️ Проверка: ${x} - ${a} = ${b}`;
      }
      
      // 4. ПЛОЩАДЬ ПРЯМОУГОЛЬНИКА
      if (msg.includes('площадь') && msg.includes('прямоугольник')) {
        const nums = msg.match(/(\d+)/g);
        if (nums && nums.length >= 2) {
          const a = parseInt(nums[0]);
          const b = parseInt(nums[1]);
          const s = a * b;
          return `✅ Площадь прямоугольника: ${s} см²\n\n📝 Формула: S = a × b\nS = ${a} × ${b} = ${s} см²`;
        }
      }
      
      // 5. ПЕРИМЕТР ПРЯМОУГОЛЬНИКА
      if (msg.includes('периметр') && msg.includes('прямоугольник')) {
        const nums = msg.match(/(\d+)/g);
        if (nums && nums.length >= 2) {
          const a = parseInt(nums[0]);
          const b = parseInt(nums[1]);
          const p = 2 * (a + b);
          return `✅ Периметр прямоугольника: ${p} см\n\n📝 Формула: P = 2(a + b)\nP = 2(${a} + ${b}) = 2 × ${a + b} = ${p} см`;
        }
      }
      
      // 6. ПЛОЩАДЬ КВАДРАТА
      if (msg.includes('площадь') && msg.includes('квадрат')) {
        const nums = msg.match(/(\d+)/g);
        if (nums && nums.length >= 1) {
          const a = parseInt(nums[0]);
          const s = a * a;
          return `✅ Площадь квадрата: ${s} см²\n\n📝 Формула: S = a²\nS = ${a}² = ${a} × ${a} = ${s} см²`;
        }
      }
      
      // 7. ПРОЦЕНТЫ
      if (msg.includes('процент')) {
        const nums = msg.match(/(\d+)/g);
        if (nums && nums.length >= 2) {
          const number = parseInt(nums[0]);
          const percent = parseInt(nums[1]);
          const result = (number * percent) / 100;
          return `✅ ${percent}% от ${number} = ${result}\n\n📝 Решение:\n${number} × ${percent} ÷ 100 = ${result}`;
        }
      }
      
      // 8. СКОРОСТЬ, ВРЕМЯ, РАССТОЯНИЕ
      if (msg.includes('скорость') || msg.includes('расстояние') || msg.includes('время')) {
        const nums = msg.match(/(\d+)/g);
        if (nums && nums.length >= 2) {
          const a = parseInt(nums[0]);
          const b = parseInt(nums[1]);
          
          if (msg.includes('скорость')) {
            const v = a / b;
            return `✅ Скорость: ${v} км/ч\n\n📝 Формула: V = S ÷ t\nV = ${a} ÷ ${b} = ${v} км/ч`;
          }
          if (msg.includes('расстояние')) {
            const s = a * b;
            return `✅ Расстояние: ${s} км\n\n📝 Формула: S = V × t\nS = ${a} × ${b} = ${s} км`;
          }
          if (msg.includes('время')) {
            const t = a / b;
            return `✅ Время: ${t} ч\n\n📝 Формула: t = S ÷ V\nt = ${a} ÷ ${b} = ${t} ч`;
          }
        }
      }
      
      // 9. ДРОБИ - СЛОЖЕНИЕ
      const fractionAdd = msg.match(/(\d+)\/(\d+)\s*\+\s*(\d+)\/(\d+)/);
      if (fractionAdd) {
        const a = parseInt(fractionAdd[1]);
        const b = parseInt(fractionAdd[2]);
        const c = parseInt(fractionAdd[3]);
        const d = parseInt(fractionAdd[4]);
        
        const numerator = a * d + c * b;
        const denominator = b * d;
        return `✅ Ответ: ${numerator}/${denominator}\n\n📝 Решение:\n${a}/${b} + ${c}/${d} = (${a}×${d} + ${c}×${b})/(${b}×${d}) = ${numerator}/${denominator}`;
      }
      
      // 10. РУССКИЙ ЯЗЫК - Проверка орфографии
      const spellingErrors = {
        'жызнь': 'жизнь (ЖИ-ШИ пиши с И)',
        'чюдо': 'чудо (ЧУ-ЩУ пиши с У)',
        'щюка': 'щука (ЧУ-ЩУ пиши с У)',
        'машына': 'машина (ЖИ-ШИ пиши с И)',
        'чяйник': 'чайник (ЧА-ЩА пиши с А)',
        'щявель': 'щавель (ЧА-ЩА пиши с А)'
      };
      
      for (let [wrong, correct] of Object.entries(spellingErrors)) {
        if (msg.includes(wrong)) {
          return `✅ Правильно: ${correct}`;
        }
      }
      
      // 11. АНГЛИЙСКИЙ - Перевод базовых слов
      const translations = {
        'кот': 'cat 🐱',
        'собака': 'dog 🐶',
        'дом': 'house 🏠',
        'школа': 'school 🏫',
        'книга': 'book 📚',
        'яблоко': 'apple 🍎',
        'привет': 'hello 👋',
        'спасибо': 'thank you 🙏',
        'пожалуйста': 'please / you\'re welcome',
        'друг': 'friend 👫'
      };
      
      for (let [ru, en] of Object.entries(translations)) {
        if (msg.includes(ru)) {
          return `✅ Перевод: ${en}`;
        }
      }
      
      // 12. ОБЩИЕ ВОПРОСЫ
      if (msg.includes('привет') || msg.includes('здравствуй')) {
        return '👋 Привет! Я Рекс, твой помощник! Задай мне задачу по математике, русскому или английскому, и я помогу её решить! 😊';
      }
      
      if (msg.includes('помощь') || msg.includes('что ты умеешь')) {
        return `🐕 Я умею решать:\n\n📐 Математика:\n• Примеры (2+2, 5×3)\n• Уравнения (x+5=10)\n• Площадь и периметр\n• Проценты\n• Скорость/время/расстояние\n• Дроби\n\n📝 Русский язык:\n• Проверка орфографии\n\n🌍 Английский:\n• Перевод слов\n\nПросто напиши задачу!`;
      }
      
      if (msg.includes('спасибо')) {
        return '😊 Пожалуйста! Рад помочь! Если есть ещё вопросы - спрашивай!';
      }
      
      // ЕСЛИ НЕ РАСПОЗНАНО
      return `🤔 Хм, я не совсем понял задачу...\n\nПопробуй написать так:\n• "2 + 2"\n• "x + 5 = 10"\n• "площадь прямоугольника 5 и 3"\n• "20% от 100"\n\nИли напиши "помощь" чтобы узнать, что я умею! 😊`;
    }

    // Функции для кнопки Рекс
    function toggleRexChat() {
      const chat = document.getElementById('rexChat');
      chat.classList.toggle('active');
    }

    async function sendToRex() {
      const input = document.getElementById('rexInput');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Добавить сообщение пользователя
      addRexMessage(message, 'user');
      input.value = '';
      
      // Показать индикатор печати
      showRexTyping();
      
      // Получить ответ от Gemini
      const response = await getRexResponse(message);
      
      // Скрыть индикатор и показать ответ
      hideRexTyping();
      addRexMessage(response, 'rex');
    }

    function addRexMessage(text, sender) {
      const messagesContainer = document.getElementById('rexMessages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `rex-message ${sender}`;
      
      const avatar = sender === 'rex' ? '🐕' : '👤';
      
      messageDiv.innerHTML = `
        <div class="rex-message-avatar">${avatar}</div>
        <div class="rex-message-content">${text}</div>
      `;
      
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function showRexTyping() {
      const messagesContainer = document.getElementById('rexMessages');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'rex-message rex';
      typingDiv.id = 'rexTyping';
      typingDiv.innerHTML = `
        <div class="rex-message-avatar">🐕</div>
        <div class="rex-message-content">
          <div class="rex-typing">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      messagesContainer.appendChild(typingDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideRexTyping() {
      const typing = document.getElementById('rexTyping');
      if (typing) typing.remove();
    }

    // Показать кнопку Рекс для учеников
    function showRexButton() {
      const button = document.getElementById('rexButton');
      if (currentUser && currentUser.role === 'student') {
        button.style.display = 'flex';
      } else {
        button.style.display = 'none';
      }
    }

    // Функции редактирования и удаления сообщений (только для админа)
    function editMessage(index) {
      if (currentUser.role !== 'admin') {
        showNotification('Только администратор может редактировать сообщения', 'error');
        return;
      }
      
      document.getElementById(`messageText${index}`).style.display = 'none';
      document.getElementById(`messageEdit${index}`).style.display = 'block';
      document.getElementById(`editInput${index}`).focus();
    }

    function cancelEdit(index) {
      document.getElementById(`messageText${index}`).style.display = 'block';
      document.getElementById(`messageEdit${index}`).style.display = 'none';
    }

    function saveEditedMessage(index) {
      if (currentUser.role !== 'admin') {
        showNotification('Только администратор может редактировать сообщения', 'error');
        return;
      }
      
      const newText = document.getElementById(`editInput${index}`).value.trim();
      
      if (!newText) {
        showNotification('Сообщение не может быть пустым', 'warning');
        return;
      }
      
      const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
      
      if (messages[index]) {
        messages[index].text = newText;
        messages[index].edited = true;
        messages[index].editedAt = new Date().toISOString();
        
        localStorage.setItem('chatMessages', JSON.stringify(messages));
        
        showNotification('Сообщение отредактировано', 'success');
        loadChatMessages();
        
        addLog('Администратор отредактировал сообщение в чате');
      }
    }

    function deleteMessage(index) {
      if (currentUser.role !== 'admin') {
        showNotification('Только администратор может удалять сообщения', 'error');
        return;
      }
      
      if (!confirm('Вы уверены, что хотите удалить это сообщение?')) {
        return;
      }
      
      const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
      
      if (messages[index]) {
        messages.splice(index, 1);
        localStorage.setItem('chatMessages', JSON.stringify(messages));
        
        showNotification('Сообщение удалено', 'success');
        loadChatMessages();
        
        addLog('Администратор удалил сообщение из чата');
      }
    }

    // Функции для учителя
    function openTeacherChat() {
      document.getElementById('chatModal').classList.add('active');
      loadChatMessages();
    }

    // Функция для админа
    function openAdminChat() {
      document.getElementById('chatModal').classList.add('active');
      loadChatMessages();
    }
    
    // Функция быстрого вызова Rex
    function callRex() {
      const input = document.getElementById('chatInput');
      input.value = 'Rex, ';
      input.focus();
    }

    // Функции таблицы лидеров
    function openLeaderboard() {
      document.getElementById('leaderboardModal').classList.add('active');
      showLeaderboardTab('students');
    }

    function showLeaderboardTab(tab) {
      if (tab === 'students') {
        document.getElementById('leaderboardStudents').style.display = 'block';
        document.getElementById('leaderboardClasses').style.display = 'none';
        document.getElementById('leaderboardStudentsBtn').className = 'btn btn-primary';
        document.getElementById('leaderboardClassesBtn').className = 'btn btn-secondary';
        loadStudentsLeaderboard();
      } else {
        document.getElementById('leaderboardStudents').style.display = 'none';
        document.getElementById('leaderboardClasses').style.display = 'block';
        document.getElementById('leaderboardStudentsBtn').className = 'btn btn-secondary';
        document.getElementById('leaderboardClassesBtn').className = 'btn btn-primary';
        loadClassesLeaderboard();
      }
    }

    function loadStudentsLeaderboard() {
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      const tbody = document.getElementById('leaderboardStudentsTable');
      
      if (!tbody) return;
      
      // Преобразуем в массив и сортируем по баллам
      const students = Object.keys(userPoints).map(login => ({
        login: login,
        ...userPoints[login]
      })).sort((a, b) => b.total - a.total);
      
      tbody.innerHTML = '';
      
      if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Нет данных</td></tr>';
        return;
      }
      
      students.forEach((student, index) => {
        const row = document.createElement('tr');
        
        let medal = '';
        if (index === 0) medal = '🥇';
        else if (index === 1) medal = '🥈';
        else if (index === 2) medal = '🥉';
        
        // Подсветка текущего пользователя
        if (currentUser && student.login === currentUser.login) {
          row.style.background = 'rgba(76, 201, 240, 0.2)';
        }
        
        row.innerHTML = `
          <td style="text-align: center; font-size: 1.5rem;">${medal || (index + 1)}</td>
          <td><strong>${student.name}</strong></td>
          <td>${student.class || '5А'}</td>
          <td><strong style="color: var(--primary-blue);">${student.total}</strong></td>
          <td>${student.cardsCompleted || 0}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function loadClassesLeaderboard() {
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      const tbody = document.getElementById('leaderboardClassesTable');
      
      if (!tbody) return;
      
      // Группируем по группам
      const classes = {};
      Object.keys(userPoints).forEach(login => {
        const student = userPoints[login];
        const className = student.class || '5А';
        
        if (!classes[className]) {
          classes[className] = {
            name: className,
            total: 0,
            students: 0
          };
        }
        
        classes[className].total += student.total;
        classes[className].students += 1;
      });
      
      // Преобразуем в массив и сортируем
      const classesArray = Object.keys(classes).map(name => ({
        ...classes[name],
        average: Math.round(classes[name].total / classes[name].students)
      })).sort((a, b) => b.total - a.total);
      
      tbody.innerHTML = '';
      
      if (classesArray.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Нет данных</td></tr>';
        return;
      }
      
      classesArray.forEach((classData, index) => {
        const row = document.createElement('tr');
        
        let medal = '';
        if (index === 0) medal = '🥇';
        else if (index === 1) medal = '🥈';
        else if (index === 2) medal = '🥉';
        
        // Подсветка класса текущего пользователя
        if (currentUser && classData.name === (currentUser.class || 'группа3')) {
          row.style.background = 'rgba(76, 201, 240, 0.2)';
        }
        
        row.innerHTML = `
          <td style="text-align: center; font-size: 1.5rem;">${medal || (index + 1)}</td>
          <td><strong>${classData.name}</strong></td>
          <td><strong style="color: var(--primary-blue);">${classData.total}</strong></td>
          <td>${classData.students}</td>
          <td>${classData.average}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Функции для создания карточек (админ)
    function showCreateCardModal() {
      document.getElementById('createCardModal').classList.add('active');
    }

    function previewCardImage() {
      const url = document.getElementById('cardImageUrl').value.trim();
      const preview = document.getElementById('cardImagePreview');
      
      if (!url) {
        showNotification('Введите URL картинки', 'error');
        return;
      }
      
      preview.src = url;
      preview.style.display = 'block';
      preview.onerror = () => {
        showNotification('Не удалось загрузить изображение', 'error');
        preview.style.display = 'none';
      };
    }

    function saveCard() {
      const title = document.getElementById('cardTitle').value.trim();
      const description = document.getElementById('cardDescription').value.trim();
      const imageUrl = document.getElementById('cardImageUrl').value.trim();
      const subject = document.getElementById('cardSubject').value;
      const grade = document.getElementById('cardGrade').value;
      const points = parseInt(document.getElementById('cardPoints').value) || 10;
      
      if (!title || !description) {
        showNotification('Заполните название и описание', 'error');
        return;
      }
      
      const cards = JSON.parse(localStorage.getItem('cards') || '[]');
      
      const newCard = {
        id: Date.now().toString(),
        title: title,
        description: description,
        imageUrl: imageUrl,
        subject: subject,
        grade: grade,
        points: points,
        created: new Date().toISOString(),
        createdBy: currentUser.login
      };
      
      cards.push(newCard);
      localStorage.setItem('cards', JSON.stringify(cards));
      
      addLog('admin', 'info', `Создана карточка: ${title} (${points} баллов)`);
      showNotification('Карточка создана успешно', 'success');
      
      closeModal('createCardModal');
      
      // Очищаем форму
      document.getElementById('cardTitle').value = '';
      document.getElementById('cardDescription').value = '';
      document.getElementById('cardImageUrl').value = '';
      document.getElementById('cardPoints').value = '10';
      document.getElementById('cardImagePreview').style.display = 'none';
      
      // Обновляем список карточек если мы на вкладке карточек
      if (document.getElementById('adminCardsTab')?.classList.contains('active')) {
        loadAdminCards();
      }
    }

    function loadAdminCards() {
      const cards = JSON.parse(localStorage.getItem('cards') || '[]');
      // Здесь можно добавить отображение карточек в админ-панели
      showNotification(`Загружено ${cards.length} карточек`, 'info');
    }

    // Обновляем функцию logout
    const originalLogout = logout;
    logout = function() {
      if (currentUser) {
        addLog('auth', 'info', `Пользователь ${currentUser.login} вышел из системы`);
      }
      
      currentUser = null;
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('currentUser');
      
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('loginModal').classList.remove('active');
      document.getElementById('adminDashboard').classList.remove('active');
      document.getElementById('teacherDashboard')?.classList.remove('active');
      document.getElementById('studentDashboard')?.classList.remove('active');
      
      showNotification('Вы вышли из системы', 'info');
    };

    // ========== НОВЫЕ ФУНКЦИИ АДМИНИСТРАТОРА ==========

    // Управление баллами ученика
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
      
      // Загружаем список учеников при открытии модальных окон
      if (modalId === 'managePointsModal' || modalId === 'studentStatsModal') {
        loadStudentsList(modalId);
      } else if (modalId === 'resetProgressModal') {
        loadStudentsListForReset();
      } else if (modalId === 'blockUserModal') {
        loadUsersListForBlock();
      }
      
      // Показываем/скрываем выбор класса
      if (modalId === 'massNotificationModal') {
        document.getElementById('notificationRecipients').addEventListener('change', function() {
          document.getElementById('classSelectDiv').style.display = 
            this.value === 'class' ? 'block' : 'none';
        });
      }
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function loadStudentsList(modalId) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const students = users.filter(u => u.role === 'student');
      
      let selectId = modalId === 'managePointsModal' ? 'pointsStudentSelect' : 'statsStudentSelect';
      const select = document.getElementById(selectId);
      
      select.innerHTML = '<option value="">Выберите ученика</option>';
      students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.login;
        option.textContent = `${student.name} (${student.login})`;
        select.appendChild(option);
      });
    }

    function loadStudentsListForReset() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const students = users.filter(u => u.role === 'student');
      
      const select = document.getElementById('resetStudentSelect');
      select.innerHTML = '<option value="">Выберите ученика</option><option value="all">Все ученики</option>';
      
      students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.login;
        option.textContent = `${student.name} (${student.login})`;
        select.appendChild(option);
      });
    }

    function loadUsersListForBlock() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const select = document.getElementById('blockUserSelect');
      
      select.innerHTML = '<option value="">Выберите пользователя</option>';
      users.forEach(user => {
        if (user.role !== 'admin') {
          const option = document.createElement('option');
          option.value = user.login;
          option.textContent = `${user.name} (${user.login}) - ${user.role}`;
          select.appendChild(option);
        }
      });
    }

    function loadStudentPoints() {
      const studentLogin = document.getElementById('pointsStudentSelect').value;
      if (!studentLogin) return;
      
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      const points = userPoints[studentLogin]?.total || 0;
      
      document.getElementById('currentStudentPoints').textContent = points;
    }

    function applyPointsChange() {
      const studentLogin = document.getElementById('pointsStudentSelect').value;
      const action = document.getElementById('pointsAction').value;
      const amount = parseInt(document.getElementById('pointsAmount').value);
      const reason = document.getElementById('pointsReason').value;
      
      if (!studentLogin) {
        showNotification('Выберите ученика', 'warning');
        return;
      }
      
      if (!amount || amount < 0) {
        showNotification('Введите корректное количество баллов', 'warning');
        return;
      }
      
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      
      if (!userPoints[studentLogin]) {
        userPoints[studentLogin] = { total: 0, history: [] };
      }
      
      let newTotal = userPoints[studentLogin].total;
      
      if (action === 'add') {
        newTotal += amount;
      } else if (action === 'remove') {
        newTotal = Math.max(0, newTotal - amount);
      } else if (action === 'set') {
        newTotal = amount;
      }
      
      userPoints[studentLogin].total = newTotal;
      userPoints[studentLogin].history.push({
        points: action === 'add' ? amount : (action === 'remove' ? -amount : amount),
        action: action,
        reason: reason || 'Изменено администратором',
        date: new Date().toISOString(),
        admin: true
      });
      
      localStorage.setItem('userPoints', JSON.stringify(userPoints));
      
      addLog('admin', 'info', `Изменены баллы ученика ${studentLogin}: ${action} ${amount}`);
      showNotification('Баллы успешно изменены', 'success');
      
      loadStudentPoints();
      document.getElementById('pointsAmount').value = '';
      document.getElementById('pointsReason').value = '';
    }

    // Массовая рассылка уведомлений
    function sendMassNotification() {
      const recipients = document.getElementById('notificationRecipients').value;
      const classValue = document.getElementById('notificationClass').value;
      const type = document.getElementById('notificationType').value;
      const title = document.getElementById('notificationTitle').value;
      const message = document.getElementById('notificationMessage').value;
      
      if (!title || !message) {
        showNotification('Заполните заголовок и сообщение', 'warning');
        return;
      }
      
      const notification = {
        id: Date.now(),
        type: type,
        title: title,
        message: message,
        recipients: recipients,
        class: classValue,
        timestamp: new Date().toISOString(),
        sender: 'admin'
      };
      
      const notifications = JSON.parse(localStorage.getItem('massNotifications') || '[]');
      notifications.push(notification);
      localStorage.setItem('massNotifications', JSON.stringify(notifications));
      
      let recipientText = recipients === 'all' ? 'всем пользователям' : 
                         recipients === 'students' ? 'всем ученикам' :
                         recipients === 'teachers' ? 'всем учителям' :
                         `классу ${classValue.toUpperCase()}`;
      
      addLog('admin', 'info', `Отправлено уведомление ${recipientText}: ${title}`);
      showNotification(`Уведомление отправлено ${recipientText}`, 'success');
      
      closeModal('massNotificationModal');
      document.getElementById('notificationTitle').value = '';
      document.getElementById('notificationMessage').value = '';
    }

    // Сброс прогресса
    function confirmResetProgress() {
      const studentLogin = document.getElementById('resetStudentSelect').value;
      const resetCards = document.getElementById('resetCards').checked;
      const resetPoints = document.getElementById('resetPoints').checked;
      const resetChat = document.getElementById('resetChat').checked;
      
      if (!studentLogin) {
        showNotification('Выберите ученика', 'warning');
        return;
      }
      
      if (!confirm('Вы уверены? Это действие нельзя отменить!')) {
        return;
      }
      
      if (studentLogin === 'all') {
        // Сброс для всех учеников
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'student');
        
        students.forEach(student => {
          resetStudentData(student.login, resetCards, resetPoints, resetChat);
        });
        
        showNotification('Прогресс всех учеников сброшен', 'success');
        addLog('admin', 'warning', 'Сброшен прогресс всех учеников');
      } else {
        resetStudentData(studentLogin, resetCards, resetPoints, resetChat);
        showNotification('Прогресс ученика сброшен', 'success');
        addLog('admin', 'warning', `Сброшен прогресс ученика ${studentLogin}`);
      }
      
      closeModal('resetProgressModal');
    }

    function resetStudentData(studentLogin, resetCards, resetPoints, resetChat) {
      if (resetCards) {
        const completedCards = JSON.parse(localStorage.getItem('completedCards') || '{}');
        delete completedCards[studentLogin];
        localStorage.setItem('completedCards', JSON.stringify(completedCards));
      }
      
      if (resetPoints) {
        const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
        delete userPoints[studentLogin];
        localStorage.setItem('userPoints', JSON.stringify(userPoints));
      }
      
      if (resetChat) {
        const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
        const filteredMessages = messages.filter(msg => msg.user !== studentLogin);
        localStorage.setItem('chatMessages', JSON.stringify(filteredMessages));
      }
    }

    // Блокировка пользователя
    function blockUser() {
      const userLogin = document.getElementById('blockUserSelect').value;
      const duration = document.getElementById('blockDuration').value;
      const reason = document.getElementById('blockReason').value;
      
      if (!userLogin) {
        showNotification('Выберите пользователя', 'warning');
        return;
      }
      
      if (!reason) {
        showNotification('Укажите причину блокировки', 'warning');
        return;
      }
      
      const blockedUsers = JSON.parse(localStorage.getItem('blockedUsers') || '{}');
      
      let unblockDate = null;
      if (duration !== 'permanent') {
        const now = new Date();
        if (duration === '1h') now.setHours(now.getHours() + 1);
        else if (duration === '24h') now.setHours(now.getHours() + 24);
        else if (duration === '7d') now.setDate(now.getDate() + 7);
        else if (duration === '30d') now.setDate(now.getDate() + 30);
        unblockDate = now.toISOString();
      }
      
      blockedUsers[userLogin] = {
        reason: reason,
        blockedAt: new Date().toISOString(),
        unblockAt: unblockDate,
        blockedBy: 'admin'
      };
      
      localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
      
      addLog('admin', 'warning', `Заблокирован пользователь ${userLogin}. Причина: ${reason}`);
      showNotification('Пользователь заблокирован', 'success');
      
      closeModal('blockUserModal');
      document.getElementById('blockReason').value = '';
    }

    // Детальная статистика ученика
    function loadStudentStats() {
      const studentLogin = document.getElementById('statsStudentSelect').value;
      if (!studentLogin) {
        document.getElementById('studentStatsContent').style.display = 'none';
        return;
      }
      
      document.getElementById('studentStatsContent').style.display = 'block';
      
      // Баллы
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      const points = userPoints[studentLogin]?.total || 0;
      document.getElementById('statsTotalPoints').textContent = points;
      
      // Пройденные карточки
      const completedCards = JSON.parse(localStorage.getItem('completedCards') || '{}');
      const completed = completedCards[studentLogin] || [];
      document.getElementById('statsCompletedCards').textContent = completed.length;
      
      // Сообщения в чате
      const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
      const userMessages = messages.filter(msg => msg.user === studentLogin);
      document.getElementById('statsChatMessages').textContent = userMessages.length;
      
      // Место в рейтинге
      const allPoints = Object.entries(userPoints).map(([login, data]) => ({
        login: login,
        points: data.total || 0
      })).sort((a, b) => b.points - a.points);
      
      const rank = allPoints.findIndex(u => u.login === studentLogin) + 1;
      document.getElementById('statsRank').textContent = rank > 0 ? `#${rank}` : '-';
      
      // История баллов
      const history = userPoints[studentLogin]?.history || [];
      const historyDiv = document.getElementById('pointsHistory');
      historyDiv.innerHTML = '';
      
      if (history.length === 0) {
        historyDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">Нет истории</p>';
      } else {
        history.slice().reverse().forEach(entry => {
          const entryDiv = document.createElement('div');
          entryDiv.style.cssText = 'padding: 10px; margin-bottom: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;';
          
          const pointsColor = entry.points > 0 ? '#4cc9a0' : '#ff4d6d';
          const pointsSign = entry.points > 0 ? '+' : '';
          
          entryDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <strong style="color: ${pointsColor};">${pointsSign}${entry.points} баллов</strong>
              <span style="font-size: 0.8rem; opacity: 0.7;">${new Date(entry.date).toLocaleString()}</span>
            </div>
            <div style="font-size: 0.9rem; opacity: 0.8;">${entry.reason || (entry.cardId ? 'За прохождение карточки' : 'Без причины')}</div>
            ${entry.admin ? '<div style="font-size: 0.8rem; color: #ff9e00; margin-top: 5px;"><i class="fas fa-crown"></i> Изменено администратором</div>' : ''}
          `;
          
          historyDiv.appendChild(entryDiv);
        });
      }
      
      // Пройденные карточки
      const cards = JSON.parse(localStorage.getItem('cards') || '[]');
      const completedCardsDiv = document.getElementById('completedCardsList');
      completedCardsDiv.innerHTML = '';
      
      if (completed.length === 0) {
        completedCardsDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">Нет пройденных карточек</p>';
      } else {
        completed.forEach(item => {
          // Поддержка старого формата (просто ID) и нового (объект)
          const cardId = typeof item === 'object' ? item.cardId : item;
          const completedDate = typeof item === 'object' ? item.completedDate : null;
          const pointsEarned = typeof item === 'object' ? item.pointsEarned : null;
          
          const card = cards.find(c => c.id === cardId);
          if (card) {
            const cardDiv = document.createElement('div');
            cardDiv.style.cssText = 'padding: 10px; margin-bottom: 10px; background: rgba(76, 201, 160, 0.1); border-radius: 8px; border-left: 3px solid var(--success-green);';
            
            let dateInfo = '';
            if (completedDate) {
              const date = new Date(completedDate);
              dateInfo = `<div style="font-size: 0.85rem; opacity: 0.7; margin-top: 5px;">
                <i class="fas fa-calendar"></i> ${date.toLocaleDateString('ru-RU')} ${date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
                ${pointsEarned ? `<span style="margin-left: 10px;"><i class="fas fa-star"></i> +${pointsEarned} баллов</span>` : ''}
              </div>`;
            }
            
            cardDiv.innerHTML = `
              <div style="font-weight: 600;">${card.title}</div>
              <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">
                <span class="tag tag-primary">${card.subject}</span>
                <span class="tag tag-success">${card.grade} класс</span>
              </div>
              ${dateInfo}
            `;
            
            completedCardsDiv.appendChild(cardDiv);
          }
        });
      }
    }

    // Экспорт всех данных
    function exportAllData() {
      const data = {
        timestamp: new Date().toISOString(),
        cards: JSON.parse(localStorage.getItem('cards') || '[]'),
        users: JSON.parse(localStorage.getItem('users') || '[]'),
        assignments: JSON.parse(localStorage.getItem('assignments') || '{}'),
        userPoints: JSON.parse(localStorage.getItem('userPoints') || '{}'),
        completedCards: JSON.parse(localStorage.getItem('completedCards') || '{}'),
        chatMessages: JSON.parse(localStorage.getItem('chatMessages') || '[]'),
        logs: JSON.parse(localStorage.getItem('systemLogs') || '[]'),
        blockedUsers: JSON.parse(localStorage.getItem('blockedUsers') || '{}'),
        massNotifications: JSON.parse(localStorage.getItem('massNotifications') || '[]')
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data.json';
      a.click();
      
      addLog('admin', 'info', 'Экспортированы все данные системы');
      showNotification('Данные экспортированы в data.json', 'success');
    }

    // Просмотр прогресса всех учеников
    function viewAllStudentsProgress() {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const students = users.filter(u => u.role === 'student');
      const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
      const completedCards = JSON.parse(localStorage.getItem('completedCards') || '{}');
      
      let html = '<h3 style="margin-bottom: 20px;"><i class="fas fa-tasks"></i> Прогресс всех учеников</h3>';
      html += '<table class="data-table"><thead><tr><th>Ученик</th><th>Баллы</th><th>Пройдено карточек</th><th>Место</th><th>Действия</th></tr></thead><tbody>';
      
      const studentsWithStats = students.map(student => ({
        ...student,
        points: userPoints[student.login]?.total || 0,
        completed: (completedCards[student.login] || []).length
      })).sort((a, b) => b.points - a.points);
      
      studentsWithStats.forEach((student, index) => {
        html += `
          <tr>
            <td><strong>${student.name}</strong><br><small>${student.login}</small></td>
            <td><span style="color: var(--primary-blue); font-weight: 700;">${student.points}</span></td>
            <td><span style="color: var(--success-green); font-weight: 700;">${student.completed}</span></td>
            <td><span style="color: var(--warning-orange); font-weight: 700;">#${index + 1}</span></td>
            <td>
              <button class="btn btn-secondary" onclick="viewStudentDetails('${student.login}')" style="padding: 5px 10px; font-size: 0.8rem;">
                <i class="fas fa-eye"></i> Детали
              </button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      
      const modal = document.createElement('div');
      modal.className = 'modal active';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 1000px;">
          ${html}
          <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="width: 100%; margin-top: 20px;">
            <i class="fas fa-times"></i> Закрыть
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function viewStudentDetails(studentLogin) {
      document.getElementById('statsStudentSelect').value = studentLogin;
      openModal('studentStatsModal');
      loadStudentStats();
    }

    // Массовая рассылка уведомлений
    function sendMassNotification() {
      const recipients = document.getElementById('notificationRecipients').value;
      const classValue = document.getElementById('notificationClass').value;
      const type = document.getElementById('notificationType').value;
      const title = document.getElementById('notificationTitle').value;
      const message = document.getElementById('notificationMessage').value;
      
      if (!title || !message) {
        showNotification('Заполните заголовок и сообщение', 'warning');
        return;
      }
      
      const notification = {
        id: Date.now(),
        type: type,
        title: title,
        message: message,
        recipients: recipients,
        class: classValue,
        timestamp: new Date().toISOString(),
        sender: 'admin'
      };
      
      const notifications = JSON.parse(localStorage.getItem('massNotifications') || '[]');
      notifications.push(notification);
      localStorage.setItem('massNotifications', JSON.stringify(notifications));
      
      let recipientText = recipients === 'all' ? 'всем пользователям' : 
                         recipients === 'students' ? 'всем ученикам' :
                         recipients === 'teachers' ? 'всем учителям' :
                         `классу ${classValue.toUpperCase()}`;
      
      addLog('admin', 'info', `Отправлено уведомление ${recipientText}: ${title}`);
      showNotification(`Уведомление отправлено ${recipientText}`, 'success');
      
      closeModal('massNotificationModal');
      document.getElementById('notificationTitle').value = '';
      document.getElementById('notificationMessage').value = '';
    }

    // Сброс прогресса
    function confirmResetProgress() {
      const studentLogin = document.getElementById('resetStudentSelect').value;
      const resetCards = document.getElementById('resetCards').checked;
      const resetPoints = document.getElementById('resetPoints').checked;
      const resetChat = document.getElementById('resetChat').checked;
      
      if (!studentLogin) {
        showNotification('Выберите ученика', 'warning');
        return;
      }
      
      if (!confirm('Вы уверены? Это действие нельзя отменить!')) {
        return;
      }
      
      if (studentLogin === 'all') {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const students = users.filter(u => u.role === 'student');
        
        students.forEach(student => {
          resetStudentData(student.login, resetCards, resetPoints, resetChat);
        });
        
        showNotification('Прогресс всех учеников сброшен', 'success');
        addLog('admin', 'warning', 'Сброшен прогресс всех учеников');
      } else {
        resetStudentData(studentLogin, resetCards, resetPoints, resetChat);
        showNotification('Прогресс ученика сброшен', 'success');
        addLog('admin', 'warning', `Сброшен прогресс ученика ${studentLogin}`);
      }
      
      closeModal('resetProgressModal');
    }

    function resetStudentData(studentLogin, resetCards, resetPoints, resetChat) {
      if (resetCards) {
        const completedCards = JSON.parse(localStorage.getItem('completedCards') || '{}');
        delete completedCards[studentLogin];
        localStorage.setItem('completedCards', JSON.stringify(completedCards));
      }
      
      if (resetPoints) {
        const userPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
        delete userPoints[studentLogin];
        localStorage.setItem('userPoints', JSON.stringify(userPoints));
      }
      
      if (resetChat) {
        const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
        const filteredMessages = messages.filter(msg => msg.user !== studentLogin);
        localStorage.setItem('chatMessages', JSON.stringify(filteredMessages));
      }
    }

    // Блокировка пользователя
    function blockUser() {
      const userLogin = document.getElementById('blockUserSelect').value;
      const duration = document.getElementById('blockDuration').value;
      const reason = document.getElementById('blockReason').value;
      
      if (!userLogin) {
        showNotification('Выберите пользователя', 'warning');
        return;
      }
      
      if (!reason) {
        showNotification('Укажите причину блокировки', 'warning');
        return;
      }
      
      const blockedUsers = JSON.parse(localStorage.getItem('blockedUsers') || '{}');
      
      let unblockDate = null;
      if (duration !== 'permanent') {
        const now = new Date();
        if (duration === '1h') now.setHours(now.getHours() + 1);
        else if (duration === '24h') now.setHours(now.getHours() + 24);
        else if (duration === '7d') now.setDate(now.getDate() + 7);
        else if (duration === '30d') now.setDate(now.getDate() + 30);
        unblockDate = now.toISOString();
      }
      
      blockedUsers[userLogin] = {
        reason: reason,
        blockedAt: new Date().toISOString(),
        unblockAt: unblockDate,
        blockedBy: 'admin'
      };
      
      localStorage.setItem('blockedUsers', JSON.stringify(blockedUsers));
      
      addLog('admin', 'warning', `Заблокирован пользователь ${userLogin}. Причина: ${reason}`);
      showNotification('Пользователь заблокирован', 'success');
      
      closeModal('blockUserModal');
      document.getElementById('blockReason').value = '';
    }

    // Экспорт всех данных
    function exportAllData() {
      const data = {
        timestamp: new Date().toISOString(),
        cards: JSON.parse(localStorage.getItem('cards') || '[]'),
        users: JSON.parse(localStorage.getItem('users') || '[]'),
        assignments: JSON.parse(localStorage.getItem('assignments') || '{}'),
        userPoints: JSON.parse(localStorage.getItem('userPoints') || '{}'),
        completedCards: JSON.parse(localStorage.getItem('completedCards') || '{}'),
        chatMessages: JSON.parse(localStorage.getItem('chatMessages') || '[]'),
        logs: JSON.parse(localStorage.getItem('systemLogs') || '[]'),
        blockedUsers: JSON.parse(localStorage.getItem('blockedUsers') || '{}'),
        massNotifications: JSON.parse(localStorage.getItem('massNotifications') || '[]')
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data.json';
      a.click();
      
      addLog('admin', 'info', 'Экспортированы все данные системы');
      showNotification('Данные экспортированы в data.json', 'success');
    }

    function viewStudentDetails(studentLogin) {
      document.getElementById('statsStudentSelect').value = studentLogin;
      openModal('studentStatsModal');
      loadStudentStats();
    }

    // ДОПОЛНИТЕЛЬНАЯ ПРОВЕРКА - показываем кнопку если пользователь ученик
    setInterval(() => {
      const rexBtn = document.getElementById('rexButton');
      if (rexBtn && currentUser && currentUser.role === 'student') {
        if (rexBtn.style.display !== 'flex') {
          rexBtn.style.display = 'flex';
          console.log('Кнопка Рекс принудительно показана через interval!');
        }
      }
    }, 500);

  </script>

  <!-- Кнопка Рекс -->
  <button class="rex-button" id="rexButton" onclick="toggleRexChat()">
    🐕
  </button>

  <!-- Окно чата Рекс -->
  <div class="rex-chat" id="rexChat">
    <div class="rex-header">
      <div class="rex-header-info">
        <div class="rex-avatar">🐕</div>
        <div>
          <div style="font-weight: 600; font-size: 1.1rem;">Рекс</div>
          <div style="font-size: 0.85rem; opacity: 0.9;">AI Ассистент</div>
        </div>
      </div>
      <button class="rex-close" onclick="toggleRexChat()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="rex-messages" id="rexMessages">
      <div class="rex-message rex">
        <div class="rex-message-avatar">🐕</div>
        <div class="rex-message-content">
          Привет! Я Рекс, твой умный помощник! 😊<br><br>
          Я умею решать задачи по:<br>
          📐 Математике (примеры, уравнения, площадь, проценты)<br>
          📝 Русскому языку (орфография)<br>
          🌍 Английскому (перевод слов)<br><br>
          Напиши "помощь" чтобы узнать больше!
        </div>
      </div>
    </div>
    
    <div class="rex-input-area">
      <input 
        type="text" 
        class="rex-input" 
        id="rexInput" 
        placeholder="Напиши свой вопрос..."
        onkeypress="if(event.key === 'Enter') sendToRex()"
      >
      <button class="rex-send" onclick="sendToRex()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>

</body>
</html>
